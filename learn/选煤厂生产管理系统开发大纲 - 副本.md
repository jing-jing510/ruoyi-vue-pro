# 选煤厂生产管理系统开发大纲

## 🎯 项目概述

基于芋道开源框架开发的选煤厂智能生产管控系统，实现生产调度、设备管理、煤质管理、安全管理等全流程数字化管理。系统采用标准数据库设计，数据标准指导后续各种选煤智能化新技术开发，确保选煤信息"一次输入，全局共享"，提高数据的真实性和唯一性。

### 技术架构
- **后端**：Spring Boot + MyBatis-Plus + SQL Server
- **前端**：Vue 3 + TypeScript + Element Plus
- **框架**：芋道开源框架 (ruoyi-vue-pro)
- **数据库**：MySQL 8.0+（支持JSON数据类型，存储半结构化数据）
- **部署**：Docker + Nginx
- **集成**：PLC数据采集、OPC UA、MQTT协议支持

---

## 📊 系统架构设计

### 模块划分

```
yudao-module-coal/                    # 选煤厂核心模块
├── production/                       # 生产调度管理
├── equipment/                        # 设备档案管理  
├── quality/                          # 煤质管理
├── safety/                          # 安全管理
├── energy/                          # 能源管理
├── report/                          # 报表统计
└── common/                          # 公共组件
```

### 数据库设计原则
- 采用 MySQL 8.0+ 数据库，支持JSON数据类型存储半结构化数据
- 遵循第三范式设计，确保数据标准化
- 支持多租户架构，数据隔离安全
- 预留扩展字段，支持后续功能扩展
- 建立完整的索引体系，优化查询性能
- 数据标准统一，支持"一次输入，全局共享"

---

## 🗄️ 数据库设计详解

### 1. 生产调度管理模块

#### 1.1 生产计划表 (coal_production_plan) - 树表结构
```sql
DROP TABLE IF EXISTS `coal_production_plan`;
CREATE TABLE `coal_production_plan` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '计划ID',
    `name` VARCHAR(100) NOT NULL COMMENT '计划名称',
    `parent_id` BIGINT NOT NULL DEFAULT 0 COMMENT '父计划ID',
    `sort` INT NOT NULL DEFAULT 0 COMMENT '显示顺序',
    `plan_code` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '计划编号',
    `plan_type` TINYINT NOT NULL COMMENT '计划类型：1年度 2月度 3日计划 4班计划',
    `plan_year` INT NULL COMMENT '计划年度',
    `plan_month` TINYINT NULL COMMENT '计划月份',
    `plan_date` DATE NULL COMMENT '计划日期',
    `shift_id` BIGINT NULL COMMENT '班次ID',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '计划状态：0停用 1正常',
    plan_path VARCHAR(500) COMMENT '计划层级路径（如：1/2/3表示年/月/日）',

    -- 计划产量数据（基础）
    `raw_coal_plan` DECIMAL(10,2) NULL COMMENT '计划入洗原煤量(吨)',

    -- 精煤产量计划（按粒度分类）
    `fine_coal_plan` DECIMAL(10,2) NULL COMMENT '计划末煤产量(吨)',
    `granular_coal_plan` DECIMAL(10,2) NULL COMMENT '计划粒煤产量(吨)',
    `large_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划大块煤产量(吨)',
    `medium_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划中块煤产量(吨)',
    `small_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划小块煤产量(吨)',

    -- 其他产品计划产量
    `middling_coal_plan` DECIMAL(10,2) NULL COMMENT '计划中煤产量(吨)',
    `slime_plan` DECIMAL(10,2) NULL COMMENT '计划煤泥产量(吨)',
    `gangue_plan` DECIMAL(10,2) NULL COMMENT '计划矸石产量(吨)',

    -- 预留计划产量字段
    `reserved_product_plan1` DECIMAL(10,2) NULL COMMENT '预留计划产量字段1(吨)',
    `reserved_product_plan2` DECIMAL(10,2) NULL COMMENT '预留计划产量字段2(吨)',

    -- 质量指标
    `fine_coal_ash` DECIMAL(5,2) NULL COMMENT '末煤灰分(%)',
    `granular_coal_ash` DECIMAL(5,2) NULL COMMENT '粒煤灰分(%)',
    `large_block_coal_ash` DECIMAL(5,2) NULL COMMENT '大块煤灰分(%)',
    `medium_block_coal_ash` DECIMAL(5,2) NULL COMMENT '中块煤灰分(%)',
    `small_block_coal_ash` DECIMAL(5,2) NULL COMMENT '小块煤灰分(%)',
    `middling_coal_ash` DECIMAL(5,2) NULL COMMENT '中煤灰分(%)',

    -- 审批信息
    `creator_id` BIGINT NULL COMMENT '制定人ID',
    `approver_id` BIGINT NULL COMMENT '审批人ID',
    `approve_time` DATETIME NULL COMMENT '审批时间',

    -- 基础字段（芋道框架标准）
    `creator` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '生产计划表（树表结构）';
```
其中用到的字典：计划层级和计划状态。

![image-20250820160535987](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250820160535987.png)

![](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250820160550262.png)

```sql

INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2000, '计划层级', 'plan_level', 0, '生产计划层级', '1', '2025-08-20 16:01:18', '1', '2025-08-20 16:01:18', 0, '1970-01-01 00:00:00');
INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2001, '计划状态', 'plan_status', 0, '', '1', '2025-08-20 16:04:06', '1', '2025-08-20 16:04:06', 0, '1970-01-01 00:00:00');



INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3003, 0, '年度', '1', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:01:49', '1', '2025-08-20 16:01:49', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3004, 2, '月度', '2', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:03', '1', '2025-08-20 16:02:03', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3005, 3, '日计划', '3', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:18', '1', '2025-08-20 16:02:18', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3006, 4, '班计划', '4', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:26', '1', '2025-08-20 16:06:31', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3007, 1, '待完成', '1', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:28', '1', '2025-08-20 16:04:28', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3008, 2, '执行中', '2', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:39', '1', '2025-08-20 16:04:39', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3009, 3, '已完成', '3', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:47', '1', '2025-08-20 16:04:47', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3010, 4, '已取消', '4', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:53', '1', '2025-08-20 16:04:53', 0);
```

##### 新增一键生成年度计划表和删除年度表

###### controller

```java
    @PostMapping("/generate-yearly-plan")
    @Operation(summary = "一键生成年度计划")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:create')")
    public CommonResult<Boolean> generateYearlyPlan(@Valid @RequestBody ProductionPlanSaveReqVO createReqVO) {
        productionPlanService.generateYearlyPlan(createReqVO);
        return success(true);
    }

    @DeleteMapping("/delete-by-year")
    @Operation(summary = "一键删除年度计划")
    @Parameter(name = "year", description = "年份", required = true, example = "2025")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')")
    public CommonResult<Boolean> deleteProductionPlanByYear(@RequestParam("year") Integer year) {
        productionPlanService.deleteProductionPlanByYear(year);
        return success(true);
    }
    @DeleteMapping("/physical-delete-by-year")
        @Operation(summary = "物理删除年度计划（调试用）")
        @Parameter(name = "year", description = "年份", required = true, example = "2025")
        @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')") // 注意：权限保持一致
        public CommonResult<Boolean> physicalDeleteProductionPlanByYear(@RequestParam("year") Integer year) {
            productionPlanService.physicalDeleteProductionPlanByYear(year);
            return success(true);
        }
```





###### mapper

```java
    default void deleteByYear(Integer year) {
            delete(new LambdaQueryWrapperX<ProductionPlanDO>()
                    .eq(ProductionPlanDO::getPlanYear, year));
        }

    @Delete("DELETE FROM coal_production_plan WHERE plan_year = #{year}")
    void physicalDeleteByYear(@Param("year") Integer year);
```





###### service

```java
   /**
     * 一键生成年度计划
     *
     * @param createReqVO 年度计划信息
     */
    void generateYearlyPlan(@Valid ProductionPlanSaveReqVO createReqVO);

    /**
     * 根据年份删除生产计划
     *
     * @param year 年份
     */
    void deleteProductionPlanByYear(Integer year);

    /**
     * 根据年份物理删除生产计划（调试用）
     *
     * @param year 年份
     */
    void physicalDeleteProductionPlanByYear(Integer year);
```







###### serviceImp

```java
@Override
    @Transactional
    public void generateYearlyPlan(ProductionPlanSaveReqVO createReqVO) {
        // 1. 插入年度计划
        ProductionPlanDO yearPlan = BeanUtils.toBean(createReqVO, ProductionPlanDO.class);
        yearPlan.setPlanYear(createReqVO.getPlanYear()); // 显式设置年份，确保保存
        productionPlanMapper.insert(yearPlan); // 插入数据库，为了获得 id

        // 2. 批量插入后续计划
        List<ProductionPlanDO> batchList = new ArrayList<>();

        // 2.1 生成月度计划
        for (int i = 1; i <= 12; i++) {
            ProductionPlanDO monthPlan = generateSubPlan(yearPlan, yearPlan.getId(), i + "月", 12, 2); // planType = 2
            monthPlan.setPlanMonth(i);
            productionPlanMapper.insert(monthPlan); // 插入数据库，为了获得 id

            // 2.2 生成日计划
            int daysInMonth = java.time.YearMonth.of(yearPlan.getPlanYear(), i).lengthOfMonth();
            for (int j = 1; j <= daysInMonth; j++) {
                // 注意：除数使用该月的实际天数，保证日计划合计约等于月计划
                ProductionPlanDO dayPlan = generateSubPlan(monthPlan, monthPlan.getId(), j + "日", daysInMonth, 3); // planType = 3
                dayPlan.setPlanDate(LocalDate.of(yearPlan.getPlanYear(), monthPlan.getPlanMonth(), j));
                productionPlanMapper.insert(dayPlan); // 插入数据库，为了获得 id

                // 2.3 生成班次计划
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "早班", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "中班", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "晚班", 3, 4)); // planType = 4
            }
        }

        // 批量插入所有班次计划
        for (ProductionPlanDO plan : batchList) {
            productionPlanMapper.insert(plan);
        }
    }
  /**
     * 生成子计划
     *
     * @param parentPlan 父计划
     * @param parentId 父计划编号
     * @param name 计划名称
     * @param subMultiple 子计划的拆分倍数
     * @param planType 计划类型
     * @return 子计划
     */
    private ProductionPlanDO generateSubPlan(ProductionPlanDO parentPlan, Long parentId, String name, int subMultiple, Integer planType) {
        ProductionPlanDO subPlan = new ProductionPlanDO();
        subPlan.setName(parentPlan.getName() + "-" + name);
        subPlan.setParentId(parentId);
        subPlan.setPlanType(planType);
        subPlan.setStatus(parentPlan.getStatus());
        subPlan.setPlanYear(parentPlan.getPlanYear()); // 继承父计划的年份

        // 将“量”相关的字段，进行除法
        subPlan.setRawCoalPlan(parentPlan.getRawCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setFineCoalPlan(parentPlan.getFineCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGranularCoalPlan(parentPlan.getGranularCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setLargeBlockCoalPlan(parentPlan.getLargeBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMediumBlockCoalPlan(parentPlan.getMediumBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSmallBlockCoalPlan(parentPlan.getSmallBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMiddlingCoalPlan(parentPlan.getMiddlingCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSlimePlan(parentPlan.getSlimePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGanguePlan(parentPlan.getGanguePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));

        // 将“灰分”相关的字段，直接复制
        subPlan.setFineCoalAsh(parentPlan.getFineCoalAsh());
        subPlan.setGranularCoalAsh(parentPlan.getGranularCoalAsh());
        subPlan.setLargeBlockCoalAsh(parentPlan.getLargeBlockCoalAsh());
        subPlan.setMediumBlockCoalAsh(parentPlan.getMediumBlockCoalAsh());
        subPlan.setSmallBlockCoalAsh(parentPlan.getSmallBlockCoalAsh());
        subPlan.setMiddlingCoalAsh(parentPlan.getMiddlingCoalAsh());
        return subPlan;
    }

    @Override
    public void deleteProductionPlanByYear(Integer year) {
        productionPlanMapper.deleteByYear(year);
    }
    @Override
    public void physicalDeleteProductionPlanByYear(Integer year) {
        productionPlanMapper.physicalDeleteByYear(year);
    } 
```







###### 前端

添加提示框

```vue
  <el-alert
      title="搜索提示：对于“一键生成”的计划，建议使用“计划名称”进行精确搜索。搜索格式示例：'2025年-12月-31日-晚班' 或 '2025年-12月-31日'。"
      type="success"
      show-icon
      :closable="true"
      style="margin-bottom: 20px; border:1px green solid;"
    />
```



添加两个按钮

```vue
    <el-button
          type="primary"
          @click="openForm('generate')"
          v-hasPermi="['coal:production-plan:create']"
        >
          <Icon icon="ep:plus" class="mr-5px" /> 一键生成年度计划
        </el-button>
        <el-button
          type="danger"
          plain
          @click="handleDeleteByYear"
          v-hasPermi="['coal:production-plan:delete']"
        >
          <Icon icon="ep:delete" class="mr-5px" /> 按年删除
        </el-button>
```





因为一键生成年度计划里面，需要填写年度计划，所以可以直接引用新增或修改的表格，也就是ProductionPlanForm.vue。所以直接添加一个generate标识为生成的，对应的是这
里：

![image-20250825113053844](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825113053844.png)



打开弹窗的ProductionPlanForm.vue后，判断是生成的时候自动填写年度计划和顶级ID

```vue
// 一键生成年度计划时，设置默认值
  if (type === 'generate') {
    formData.value.planType = 1 // 1 代表年度计划
    formData.value.parentId = 0 // 0 代表顶级
  }
```





提交是执行generationYearPlan方法

```ts
if (formType.value === 'generate') {
      await ProductionPlanApi.generateYearlyPlan(data)
      message.success('一键生成年度计划成功')
```





```TS
// TS代码

// 一键生成年度计划
  generateYearlyPlan: async (data: ProductionPlan) => {
    return await request.post({ url: `/coal/production-plan/generate-yearly-plan`, data })
  },

  // 按年份删除生产计划
  deleteProductionPlanByYear: async (year: number) => {
    return await request.delete({ url: `/coal/production-plan/delete-by-year?year=` + year })
  },
```



对于删除逻辑就是传递年份然后执行delete-by-year方法

```ts
/** 按年份删除按钮操作 */
const handleDeleteByYear = async () => {
  try {
    const { value } = await ElMessageBox.prompt('请输入要删除的年份', '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      inputPattern: /^\d{4}$/,
      inputErrorMessage: '请输入有效的四位年份'
    })
    if (value) {
      await message.delConfirm('确认要删除 ' + value + ' 年的所有计划数据吗？')
      await ProductionPlanApi.deleteProductionPlanByYear(Number(value))
      message.success(t('common.delSuccess'))
      await getList()
    }
  } catch {}
}
```





###### 调试

![image-20250825112725106](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825112725106.png)

**生成年度计划：**



![image-20250825143905527](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143905527.png)

![image-20250825143920623](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143920623.png)



![image-20250825143927935](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143927935.png)**删除：**

![image-20250825143414516](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143414516.png)

![image-20250825143420016](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143420016.png)

数据库中不是真的删除，而是逻辑删除。

![image-20250825143450111](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143450111.png)

如果要物理删除，使用http://127.0.0.1:48080/doc.html#/all/%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%20-%20%E7%94%9F%E4%BA%A7%E8%AE%A1%E5%88%92/
physicalDeleteProductionPlanByYear

进行物理删除。



![image-20250825143524687](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143524687.png)

![image-20250825143531790](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143531790.png)

![image-20250825143537521](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143537521.png)


#### 1.2 现场生产日报表 (coal_production_daily_report)
```sql
CREATE TABLE `coal_production_daily_report` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日报id',
  `report_date` datetime NOT NULL COMMENT '日期',
  `shift_id` bigint DEFAULT NULL COMMENT '班次ID',
  `operator_id` bigint DEFAULT NULL COMMENT '集控员（操作人）ID',
  `shift_leader_id` bigint DEFAULT NULL COMMENT '带班主任/班长ID',
  `start_time` datetime DEFAULT NULL COMMENT '启车时间',
  `coal_feeding_time` int DEFAULT NULL COMMENT '带煤时间(分钟)',
  `stop_time` datetime DEFAULT NULL COMMENT '停车时间',
  `effective_feeding_time` int DEFAULT NULL COMMENT '有效带煤时间(分钟)',
  `fault_impact_time` int DEFAULT NULL COMMENT '故障影响时间(分钟)',
  `raw_coal_input` decimal(10,2) DEFAULT NULL COMMENT '入洗煤量(吨)',
  `hourly_capacity` decimal(8,2) DEFAULT NULL COMMENT '小时处理量(吨/小时)',
  `block_clean_coal_output` decimal(10,2) DEFAULT NULL COMMENT '块精煤产量(吨)',
  `fine_clean_coal_output` decimal(10,2) DEFAULT NULL COMMENT '末精煤产量(吨)',
  `gangue_output` decimal(10,2) DEFAULT NULL COMMENT '矸石产量(吨)',
  `middling_coal_output` decimal(10,2) DEFAULT NULL COMMENT '中煤产量(吨)',
  `filter_press_cycles` int DEFAULT NULL COMMENT '压滤板次',
  `filter_press_coal_amount` decimal(8,2) DEFAULT NULL COMMENT '压滤煤量(吨)',
  `filter_cloth_usage` int DEFAULT NULL COMMENT '滤布使用量(张)',
  `discharge_record` varchar(500) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '放舱记录',
  `baffle_medium_addition` decimal(8,2) DEFAULT NULL COMMENT '挡板添加介质量(kg)',
  `cao_amount` decimal(8,2) DEFAULT NULL COMMENT 'CaO量(kg)',
  `flocculant_amount` decimal(8,2) DEFAULT NULL COMMENT '絮凝剂(kg)',
  `density_MD317` decimal(5,2) DEFAULT NULL COMMENT '317密度(kg/L)',
  `first_ash_block_clean` decimal(5,2) DEFAULT NULL COMMENT '第一次块精煤灰分(%)',
  `first_ash_fine_clean` decimal(5,2) DEFAULT NULL COMMENT '第一次末精煤灰分(%)',
  `first_ash_middling` decimal(5,2) DEFAULT NULL COMMENT '第一次中煤灰分(%)',
  `first_ash_slime` decimal(5,2) DEFAULT NULL COMMENT '第一次煤泥灰分(%)',
  `first_ash_gangue` decimal(5,2) DEFAULT NULL COMMENT '第一次矸石灰分(%)',
  `second_ash_block_clean` decimal(5,2) DEFAULT NULL COMMENT '第二次块精煤灰分(%)',
  `second_ash_fine_clean` decimal(5,2) DEFAULT NULL COMMENT '第二次末精煤灰分(%)',
  `second_ash_middling` decimal(5,2) DEFAULT NULL COMMENT '第二次中煤灰分(%)',
  `second_ash_slime` decimal(5,2) DEFAULT NULL COMMENT '第二次煤泥灰分(%)',
  `second_ash_gangue` decimal(5,2) DEFAULT NULL COMMENT '第二次矸石灰分(%)',
  `impact_time_record` text COLLATE utf8mb4_unicode_ci COMMENT '影响时间记录详情',
  `assigned_tasks` text COLLATE utf8mb4_unicode_ci COMMENT '交办事项',
  `start_circulating_water_pool` decimal(6,2) DEFAULT NULL COMMENT '启车循环水池液位',
  `start_clean_water_tank` decimal(6,2) DEFAULT NULL COMMENT '启车清水桶液位',
  `start_fine_coal_level` decimal(6,2) DEFAULT NULL COMMENT '启车末煤仓位',
  `start_granular_coal_level` decimal(6,2) DEFAULT NULL COMMENT '启车粒煤仓位',
  `start_large_block_level` decimal(6,2) DEFAULT NULL COMMENT '启车大块仓位',
  `start_medium_block_level` decimal(6,2) DEFAULT NULL COMMENT '启车中块仓位',
  `start_small_block_level` decimal(6,2) DEFAULT NULL COMMENT '启车小块仓位',
  `start_middling_coal_level` decimal(6,2) DEFAULT NULL COMMENT '启车中煤仓位',
  `start_gangue_level` decimal(6,2) DEFAULT NULL COMMENT '启车矸石仓位',
  `stop_circulating_water_pool` decimal(6,2) DEFAULT NULL COMMENT '停车循环水池液位',
  `stop_clean_water_tank` decimal(6,2) DEFAULT NULL COMMENT '停车清水桶液位',
  `stop_fine_coal_level` decimal(6,2) DEFAULT NULL COMMENT '停车末煤仓位',
  `stop_granular_coal_level` decimal(6,2) DEFAULT NULL COMMENT '停车粒煤仓位',
  `stop_large_block_level` decimal(6,2) DEFAULT NULL COMMENT '停车大块仓位',
  `stop_medium_block_level` decimal(6,2) DEFAULT NULL COMMENT '停车中块仓位',
  `stop_small_block_level` decimal(6,2) DEFAULT NULL COMMENT '停车小块仓位',
  `stop_middling_coal_level` decimal(6,2) DEFAULT NULL COMMENT '停车中煤仓位',
  `stop_gangue_level` decimal(6,2) DEFAULT NULL COMMENT '停车矸石仓位',
  `remarks` text COLLATE utf8mb4_unicode_ci COMMENT '备注信息',
  `reserved_field1` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '预留字段1',
  `reserved_field2` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '预留字段2',
  `reserved_field3` decimal(10,2) DEFAULT NULL COMMENT '预留字段3',
  `reserved_field4` decimal(10,2) DEFAULT NULL COMMENT '预留字段4',
  `reserved_field5` text COLLATE utf8mb4_unicode_ci COMMENT '预留字段5',
  `creator` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT '0' COMMENT '是否删除',
  `tenant_id` bigint DEFAULT '0' COMMENT '租户ID',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1120870174271299585 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='现场生产日报表';
```
###### 更改时间格式

由于生产日报中日期是不带时间的，启车时间和停车时间要精确到秒，这样才合理。所以需要更改前端代码，通过看源码

https://doc.iocoder.cn/validator/#_5-1-query-%E6%97%B6%E9%97%B4%E4%BC%A0%E5%8F%82

发现时间传参，需要两点：1后端更改@DateTimeFormat(pattern = FORMAT_YEAR_MONTH_DAY_HOUR_MINUTE_SECOND)，

```java
/**
     * 秒转换成毫秒
     */
    public static final long SECOND_MILLIS = 1000;

    public static final String FORMAT_YEAR_MONTH_DAY = "yyyy-MM-dd";

    public static final String FORMAT_YEAR_MONTH_DAY_HOUR_MINUTE_SECOND = "yyyy-MM-dd HH:mm:ss";

```





对应这一块，选择对应的事件，最后发现后端不需要更改，就年月日时分秒就行，对于前端要进行修改：

```vue
  <el-form-item label="启车时间" prop="startTime">
        <el-date-picker
          v-model="formData.startTime"
          type="datetime"
          value-format="x"
          placeholder="选择启车时间"
        />
      </el-form-item>
      
      <el-form-item label="停车时间" prop="stopTime">
        <el-date-picker
          v-model="formData.stopTime"
          type="datetime"
          value-format="x"
          placeholder="选择停车时间"
        />
      </el-form-item>
```





将type类型更改为datetime，他才能选择时分秒的数值。



![image-20250828151050274](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828151050274.png)





![image-20250828151104502](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828151104502.png)

这是新增或者修改的时候修改的内容。

对于前端列表展示页面，一开始生成的时候是只有日月年时分秒。前端提供了方法进行转换。



![image-20250828151256638](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828151256638.png)

```vue
 <el-table-column
        label="日期"
        align="center"
        prop="reportDate"
        :formatter="dateFormatter2"
        width="180px"
      />
```





将日期更改格式即可。

这样后端统一都是datetime格式，

![image-20250828151351825](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828151351825.png)



但是前端页面展示是：



![image-20250828151415766](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828151415766.png)



###### 集控员和带班主任更改



通过获取本地的用户表，这样就可以将集控员和带班主任内容进行下来框，并且新增或修改的时候输入的是id，展示的是昵称。

```vue
<el-form-item label="集控员（操作人）" prop="operatorId">
        <el-select v-model="formData.operatorId" placeholder="请选择集控员（操作人）" clearable filterable>
          <el-option
            v-for="user in userList"
            :key="user.id"
            :label="user.nickname"
            :value="user.id"
          />
        </el-select>
      </el-form-item>
      <el-form-item label="带班主任/班长" prop="shiftLeaderId">
        <el-select v-model="formData.shiftLeaderId" placeholder="请选择带班主任/班长" clearable filterable>
          <el-option
            v-for="user in userList"
            :key="user.id"
            :label="user.nickname"
            :value="user.id"
          />
        </el-select>
      </el-form-item>
      
import { getSimpleUserList, UserVO } from '@/api/system/user'
const userList = ref<UserVO[]>([]) // 用户列表
    
/** 加载用户列表 */
const loadUserList = async () => {
  try {
    const data = await getSimpleUserList()
    userList.value = data
  } catch (error) {
    console.error('加载用户列表失败:', error)
    userList.value = []
  }
}
/** 初始化 **/
onMounted(() => {
  loadUserList()
})
```





index.vue展示页面：

```vue
<el-table-column label="集控员" align="center" prop="operatorId">
        <template #default="scope">
          {{ getUserNickname(scope.row.operatorId) }}
        </template>
      </el-table-column>
      <el-table-column label="带班主任" align="center" prop="shiftLeaderId">
        <template #default="scope">
          {{ getUserNickname(scope.row.shiftLeaderId) }}
        </template>
      </el-table-column>

import { getSimpleUserList, UserVO } from '@/api/system/user'
const userList = ref<UserVO[]>([]) // 用户列表

/** 根据用户ID获取用户昵称 */
const getUserNickname = (userId: number | undefined) => {
  if (!userId) return ''
  const user = userList.value.find(u => u.id === userId)
  return user ? user.nickname : `用户${userId}`
}
/** 加载用户列表 */
const loadUserList = async () => {
  try {
    const data = await getSimpleUserList()
    userList.value = data
  } catch (error) {
    console.error('加载用户列表失败:', error)
    userList.value = []
  }
}
/** 初始化 **/
onMounted(() => {
  getList()
  loadUserList()
})
```







###### 在线填表

通过报表设计器设计了在线填表，之后就可以直接跳转链接，在线填表。然后可以支持打印导出。





```vue
<el-button
  type="primary"
  plain
  @click="openOnlineReport"
>
  <Icon icon="ep:plus" class="mr-5px" /> 在线填报
</el-button>
```

```ts
/** 在线填报按钮操作 */
const openOnlineReport = () => {
  const url = 'http://localhost:48080/jmreport/shareView/1120595319747600384?shareToken=39303adec4dd28332e4ce1f063e17be7'
  window.open(url, '_blank')
}
```





![image-20250828152156677](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828152156677.png)

![image-20250828152212604](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250828152212604.png)


#### 1.3 计划完成率统计表 (coal_plan_completion_statistics)
```sql
CREATE TABLE coal_plan_completion_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL COMMENT '计划ID',
    statistics_date DATE NOT NULL COMMENT '统计日期',
    statistics_type TINYINT NOT NULL COMMENT '统计类型：1日统计 2月统计 3年统计 4班统计',

    -- 计划数据
    plan_raw_coal DECIMAL(10,2),                  -- 计划入洗原煤量(吨)
    plan_fine_coal DECIMAL(10,2),                 -- 计划末煤产量(吨)
    plan_granular_coal DECIMAL(10,2),             -- 计划粒煤产量(吨)
    plan_large_block_coal DECIMAL(10,2),          -- 计划大块煤产量(吨)
    plan_medium_block_coal DECIMAL(10,2),         -- 计划中块煤产量(吨)
    plan_small_block_coal DECIMAL(10,2),          -- 计划小块煤产量(吨)
    plan_middling_coal DECIMAL(10,2),             -- 计划中煤产量(吨)
    plan_gangue DECIMAL(10,2),                    -- 计划矸石产量(吨)

    -- 实际完成数据
    actual_raw_coal DECIMAL(10,2),                -- 实际入洗原煤量(吨)
    actual_fine_coal DECIMAL(10,2),               -- 实际末煤产量(吨)
    actual_granular_coal DECIMAL(10,2),           -- 实际粒煤产量(吨)
    actual_large_block_coal DECIMAL(10,2),        -- 实际大块煤产量(吨)
    actual_medium_block_coal DECIMAL(10,2),       -- 实际中块煤产量(吨)
    actual_small_block_coal DECIMAL(10,2),        -- 实际小块煤产量(吨)
    actual_middling_coal DECIMAL(10,2),           -- 实际中煤产量(吨)
    actual_gangue DECIMAL(10,2),                  -- 实际矸石产量(吨)

    -- 完成率数据（百分比）
    completion_rate_raw_coal DECIMAL(5,2),        -- 入洗原煤完成率(%)
    completion_rate_fine_coal DECIMAL(5,2),       -- 末煤完成率(%)
    completion_rate_granular_coal DECIMAL(5,2),   -- 粒煤完成率(%)
    completion_rate_large_block DECIMAL(5,2),     -- 大块煤完成率(%)
    completion_rate_medium_block DECIMAL(5,2),    -- 中块煤完成率(%)
    completion_rate_small_block DECIMAL(5,2),     -- 小块煤完成率(%)
    completion_rate_middling_coal DECIMAL(5,2),   -- 中煤完成率(%)
    completion_rate_gangue DECIMAL(5,2),          -- 矸石完成率(%)

    -- 总体完成率
    overall_completion_rate DECIMAL(5,2),         -- 总体完成率(%)

    -- 统计状态
    statistics_status TINYINT DEFAULT 1,          -- 统计状态：1正常 2异常 3需关注

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 班次管理模块（主子表结构设计）

##### 1.4.1 业务逻辑与表结构设计
班次管理采用主子表结构设计，完美适配芋道代码生成器的主子表功能，支持一个主表对应多个子表的模式。

- **主表：班次配置表 (`coal_shift_config`)** - 定义班次的基础模板，如“早班”、“中班”及其对应的时间段。
- **子表1：班次排班表 (`coal_shift_schedule`)** - 关联班次配置，用于指定某个班次模板在具体日期的排班安排。
- **子表2：人员排班表 (`coal_shift_staff`)** - 关联班次配置，用于将具体员工分配到某个班次的某个日期中。

**表关系：**
```
coal_shift_config (班次配置) - 主表
    ├── coal_shift_schedule (班次排班) - 子表1，通过 shift_config_id 关联
    └── coal_shift_staff (人员排班) - 子表2，通过 shift_config_id 关联
```

**设计优势：**
- 符合芋道代码生成器的主子表限制
- 可以在一个界面中同时管理班次排班和人员排班
- 通过 `shift_config_id` + `schedule_date` 实现数据关联
- 业务逻辑清晰，操作便捷

**业务场景示例：**
```
班次配置（相对固定）：
- 早班：08:00-16:00（8小时）
- 中班：16:00-24:00（8小时）
- 晚班：00:00-08:00（8小时，跨天）

班次排班（灵活安排）：
- 早班：2025年1月15日、18日、20日、22日...
- 中班：2025年1月16日、19日、21日、23日...
- 晚班：2025年1月17日、20日、22日、24日...

人员排班（具体执行）：
- 2025年1月15日早班：张三（调度员、班长）、李四（操作工）、王五（检修工）、赵六（安全员）
```

##### 1.4.2 班次配置表 (coal_shift_config)
```sql
DROP TABLE IF EXISTS `coal_shift_config`;
CREATE TABLE `coal_shift_config` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '班次配置ID',
    `shift_name` VARCHAR(50) NOT NULL COMMENT '班次名称（如：早班、中班、晚班）',
    `shift_code` VARCHAR(20) NOT NULL COMMENT '班次编码（如：MORNING、AFTERNOON、NIGHT）',
    `start_time` TIME NOT NULL COMMENT '班次开始时间（如：08:00）',
    `end_time` TIME NOT NULL COMMENT '班次结束时间（如：16:00）',
    `shift_type` TINYINT NOT NULL COMMENT '班次类型：1生产班 2检修班 3值班',
    `is_cross_day` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否跨天班次：0否 1是',
    `work_hours` DECIMAL(4,2) NOT NULL COMMENT '工作时长（小时）',
    `sort_order` INT NOT NULL DEFAULT 0 COMMENT '排序',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0禁用 1启用',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_shift_code` (`shift_code`, `deleted`) COMMENT '班次编码唯一索引'
) ENGINE = InnoDB COMMENT = '班次配置表';
```

##### 1.4.3 班次排班表 (coal_shift_schedule)
```sql
DROP TABLE IF EXISTS `coal_shift_schedule`;
CREATE TABLE `coal_shift_schedule` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '班次排班ID',
    `shift_config_id` BIGINT NOT NULL COMMENT '班次配置ID',
    `schedule_date` DATE NOT NULL COMMENT '排班日期',
    `schedule_status` TINYINT NOT NULL DEFAULT 1 COMMENT '排班状态：1正常 2停产 3检修 4取消',
    `planned_staff_count` INT NOT NULL DEFAULT 0 COMMENT '计划人员数量',
    `actual_staff_count` INT NOT NULL DEFAULT 0 COMMENT '实际人员数量',
    `shift_leader_id` BIGINT NULL COMMENT '班长ID',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    KEY `idx_shift_config_id` (`shift_config_id`),
    KEY `idx_schedule_date` (`schedule_date`),
    UNIQUE KEY `uk_shift_schedule` (`shift_config_id`, `schedule_date`, `deleted`) COMMENT '班次日期唯一索引'
) ENGINE = InnoDB COMMENT = '班次排班表';
```

##### 1.4.4 人员排班表 (coal_shift_staff)
```sql
DROP TABLE IF EXISTS `coal_shift_staff`;
CREATE TABLE `coal_shift_staff` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '人员排班ID',
    `shift_config_id` BIGINT NOT NULL COMMENT '班次配置ID（关联主表）',
    `schedule_date` DATE NOT NULL COMMENT '排班日期',
    `user_id` BIGINT NOT NULL COMMENT '员工ID',
    `position_type` TINYINT NOT NULL COMMENT '岗位类型：1调度员 2操作工 3检修工 4安全员 5质检员',
    `is_leader` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否班长：0否 1是',
    `attendance_status` TINYINT NOT NULL DEFAULT 1 COMMENT '出勤状态：1正常 2请假 3迟到 4早退 5旷工',
    `replacement_user_id` BIGINT NULL COMMENT '替班人员ID',
    `work_start_time` DATETIME NULL COMMENT '实际上班时间',
    `work_end_time` DATETIME NULL COMMENT '实际下班时间',
    `overtime_hours` DECIMAL(4,2) DEFAULT 0 COMMENT '加班时长（小时）',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    KEY `idx_shift_config_id` (`shift_config_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_schedule_date` (`schedule_date`),
    UNIQUE KEY `uk_staff_schedule` (`shift_config_id`, `schedule_date`, `user_id`, `position_type`, `deleted`) COMMENT '人员排班唯一索引'
) ENGINE = InnoDB COMMENT = '人员排班表';
```

##### 1.4.5 考勤系统集成设计（后期扩展）
为后期集成考勤功能，预先设计以下表结构，可与人员排班表 (`coal_shift_staff`) 关联。

**考勤记录表 (coal_attendance_record)**
```sql
CREATE TABLE `coal_attendance_record` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '考勤记录ID',
    `shift_staff_id` BIGINT NOT NULL COMMENT '人员排班ID',
    `user_id` BIGINT NOT NULL COMMENT '员工ID',
    `attendance_date` DATE NOT NULL COMMENT '考勤日期',
    `check_in_time` DATETIME NULL COMMENT '签到时间',
    `check_out_time` DATETIME NULL COMMENT '签退时间',
    `attendance_type` TINYINT NOT NULL COMMENT '考勤类型：1正常 2迟到 3早退 4旷工 5请假',
    `work_duration` DECIMAL(4,2) DEFAULT 0 COMMENT '工作时长（小时）',
    `overtime_duration` DECIMAL(4,2) DEFAULT 0 COMMENT '加班时长（小时）',
    `location_info` VARCHAR(200) NULL COMMENT '考勤地点信息',
    `device_info` VARCHAR(100) NULL COMMENT '考勤设备信息',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    KEY `idx_shift_staff_id` (`shift_staff_id`),
    KEY `idx_user_date` (`user_id`, `attendance_date`)
) ENGINE = InnoDB COMMENT = '考勤记录表';
```

**考勤统计表 (coal_attendance_statistics)**
```sql
CREATE TABLE `coal_attendance_statistics` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '考勤统计ID',
    `user_id` BIGINT NOT NULL COMMENT '员工ID',
    `statistics_month` VARCHAR(7) NOT NULL COMMENT '统计月份（YYYY-MM）',
    `work_days` INT DEFAULT 0 COMMENT '应出勤天数',
    `actual_days` INT DEFAULT 0 COMMENT '实际出勤天数',
    `late_times` INT DEFAULT 0 COMMENT '迟到次数',
    `early_leave_times` INT DEFAULT 0 COMMENT '早退次数',
    `absent_days` INT DEFAULT 0 COMMENT '旷工天数',
    `leave_days` INT DEFAULT 0 COMMENT '请假天数',
    `overtime_hours` DECIMAL(6,2) DEFAULT 0 COMMENT '加班时长（小时）',
    `attendance_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '出勤率（%）',
    `creator` VARCHAR(64) NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_user_month` (`user_id`, `statistics_month`, `deleted`)
) ENGINE = InnoDB COMMENT = '考勤统计表';
```

##### 1.4.6 字典数据配置
```sql
-- 班次类型: shift_type
-- 岗位类型: position_type
-- 排班状态: schedule_status
-- 出勤状态: attendance_status
-- 考勤类型: attendance_type
```
```sql
-- 班次类型字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES ('班次类型', 'shift_type', 0, '班次类型', '1', NOW(), '1', NOW(), 0);

-- 岗位类型字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES ('岗位类型', 'position_type', 0, '排班岗位类型', '1', NOW(), '1', NOW(), 0);

-- 排班状态字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES ('排班状态', 'schedule_status', 0, '班次排班状态', '1', NOW(), '1', NOW(), 0);

-- 出勤状态字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES ('出勤状态', 'attendance_status', 0, '人员出勤状态', '1', NOW(), '1', NOW(), 0);

-- 班次类型数据
INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '生产班', '1', 'shift_type', 0, '1', NOW(), '1', NOW()),
(2, '检修班', '2', 'shift_type', 0, '1', NOW(), '1', NOW()),
(3, '值班', '3', 'shift_type', 0, '1', NOW(), '1', NOW());

-- 岗位类型数据
INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '调度员', '1', 'position_type', 0, '1', NOW(), '1', NOW()),
(2, '操作工', '2', 'position_type', 0, '1', NOW(), '1', NOW()),
(3, '检修工', '3', 'position_type', 0, '1', NOW(), '1', NOW()),
(4, '安全员', '4', 'position_type', 0, '1', NOW(), '1', NOW()),
(5, '质检员', '5', 'position_type', 0, '1', NOW(), '1', NOW());

-- 排班状态数据
INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '正常', '1', 'schedule_status', 0, '1', NOW(), '1', NOW()),
(2, '停产', '2', 'schedule_status', 0, '1', NOW(), '1', NOW()),
(3, '检修', '3', 'schedule_status', 0, '1', NOW(), '1', NOW()),
(4, '取消', '4', 'schedule_status', 0, '1', NOW(), '1', NOW());

-- 出勤状态数据
INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '正常', '1', 'attendance_status', 0, '1', NOW(), '1', NOW()),
(2, '请假', '2', 'attendance_status', 0, '1', NOW(), '1', NOW()),
(3, '迟到', '3', 'attendance_status', 0, '1', NOW(), '1', NOW()),
(4, '早退', '4', 'attendance_status', 0, '1', NOW(), '1', NOW()),
(5, '旷工', '5', 'attendance_status', 0, '1', NOW(), '1', NOW());

##### 1.4.7 代码生成器使用建议

**使用芋道代码生成器的主子表功能：**

- **主表：** `coal_shift_config`（班次配置表）
- **子表1：** `coal_shift_schedule`（班次排班表）- 关联字段：`shift_config_id`
- **子表2：** `coal_shift_staff`（人员排班表）- 关联字段：`shift_config_id`

**生成配置：**
- 模板类型：主子表
- 主表：coal_shift_config
- 子表：coal_shift_schedule, coal_shift_staff
- 关联字段：shift_config_id

**界面操作流程：**
1. 在班次配置页面，可以同时看到该班次的排班计划和人员安排
2. 新增班次配置时，可以直接添加排班日期和人员分配
3. 编辑时可以统一管理班次的所有相关信息

**数据关联逻辑：**
- 班次排班表和人员排班表都直接关联班次配置表
- 通过 `shift_config_id` + `schedule_date` 可以关联同一天的排班和人员信息
- 保持数据一致性，避免复杂的三层关联

### 2. 设备档案管理模块

#### 2.1 设备基础信息表 (coal_equipment_info)
```sql
CREATE TABLE coal_equipment_info (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_code NVARCHAR(50) NOT NULL,         -- 设备编号
    equipment_name NVARCHAR(100) NOT NULL,        -- 设备名称
    equipment_type_id BIGINT NOT NULL,            -- 设备类型ID
    system_id BIGINT NOT NULL,                    -- 所属系统ID
    workshop_id BIGINT,                           -- 所属车间ID
    
    -- 设备基本信息
    model NVARCHAR(100),                          -- 设备型号
    manufacturer NVARCHAR(100),                   -- 制造厂商
    manufacture_date DATE,                        -- 制造日期
    install_date DATE,                            -- 安装日期
    commission_date DATE,                         -- 投产日期
    
    -- 技术参数
    rated_power DECIMAL(10,2),                    -- 额定功率(kW)
    rated_capacity DECIMAL(10,2),                 -- 额定处理能力(t/h)
    weight DECIMAL(10,2),                         -- 设备重量(t)
    dimensions NVARCHAR(100),                     -- 外形尺寸
    
    -- 设备状态
    equipment_status TINYINT DEFAULT 1,           -- 设备状态：1正常 2故障 3检修 4停用
    health_level TINYINT DEFAULT 1,               -- 健康等级：1优良 2良好 3注意 4异常
    
    -- 位置信息
    location NVARCHAR(200),                       -- 安装位置
    qr_code NVARCHAR(200),                        -- 二维码
    
    -- 责任人
    responsible_person_id BIGINT,                 -- 责任人ID
    maintenance_person_id BIGINT,                 -- 维护人ID
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

*... (rest of the document remains the same)* ...
