# 备件使用记录关联功能实现总结

## 功能需求
修改备件使用记录页面，让它能够关联检修单和维护计划：
- 新增/编辑时，工单ID改为下拉选择检修单编号，传参传检修单ID
- 新增/编辑时，维护计划ID改为下拉选择维护计划名称，传参传计划ID
- 列表显示时，显示检修单编号和维护计划名称而不是ID

## 实现方案

### 1. 表单页面修改 (`SparePartUsageRecordForm.vue`)

#### 1.1 表单字段修改
**工单ID字段**:
```html
<!-- 修改前 -->
<el-form-item label="工单ID(关联检修单)" prop="workOrderId">
  <el-input v-model="formData.workOrderId" placeholder="请输入工单ID(关联检修单)" />
</el-form-item>

<!-- 修改后 -->
<el-form-item label="关联检修单" prop="workOrderId">
  <el-select v-model="formData.workOrderId" placeholder="请选择检修单" clearable filterable>
    <el-option
      v-for="order in maintenanceOrderList"
      :key="order.id"
      :label="order.orderCode"
      :value="order.id"
    />
  </el-select>
</el-form-item>
```

**维护计划ID字段**:
```html
<!-- 修改前 -->
<el-form-item label="维护计划ID" prop="maintenancePlanId">
  <el-input v-model="formData.maintenancePlanId" placeholder="请输入维护计划ID" />
</el-form-item>

<!-- 修改后 -->
<el-form-item label="关联维护计划" prop="maintenancePlanId">
  <el-select v-model="formData.maintenancePlanId" placeholder="请选择维护计划" clearable filterable>
    <el-option
      v-for="plan in maintenancePlanList"
      :key="plan.id"
      :label="plan.planName"
      :value="plan.id"
    />
  </el-select>
</el-form-item>
```

#### 1.2 脚本部分修改
**添加导入**:
```typescript
import { MaintenanceOrderApi, MaintenanceOrder } from '@/api/coal/maintenanceorder'
import { MaintenancePlanApi, MaintenancePlan } from '@/api/coal/maintenanceplan'
```

**添加数据列表**:
```typescript
const maintenanceOrderList = ref<MaintenanceOrder[]>([]) // 检修单列表
const maintenancePlanList = ref<MaintenancePlan[]>([]) // 维护计划列表
```

**添加获取函数**:
```typescript
/** 获取检修单列表 */
const getMaintenanceOrderList = async () => {
  try {
    const data = await MaintenanceOrderApi.getMaintenanceOrderPage({ pageNo: 1, pageSize: 100 })
    maintenanceOrderList.value = data.list || []
  } catch (error) {
    console.error('获取检修单列表失败:', error)
  }
}

/** 获取维护计划列表 */
const getMaintenancePlanList = async () => {
  try {
    const data = await MaintenancePlanApi.getMaintenancePlanPage({ pageNo: 1, pageSize: 100 })
    maintenancePlanList.value = data.list || []
  } catch (error) {
    console.error('获取维护计划列表失败:', error)
  }
}
```

**修改打开弹窗逻辑**:
```typescript
// 加载用户列表、备件列表、检修单列表和维护计划列表
await Promise.all([
  getUserList(),
  getSparePartList(),
  getMaintenanceOrderList(),
  getMaintenancePlanList()
])
```

### 2. 列表页面修改 (`index.vue`)

#### 2.1 表格列修改
**工单ID列**:
```html
<!-- 修改前 -->
<el-table-column label="工单ID(关联检修单)" align="center" prop="workOrderId" />

<!-- 修改后 -->
<el-table-column label="关联检修单" align="center" prop="workOrderId">
  <template #default="scope">
    {{ getMaintenanceOrderName(scope.row.workOrderId) }}
  </template>
</el-table-column>
```

**维护计划ID列**:
```html
<!-- 修改前 -->
<el-table-column label="维护计划ID" align="center" prop="maintenancePlanId" />

<!-- 修改后 -->
<el-table-column label="关联维护计划" align="center" prop="maintenancePlanId">
  <template #default="scope">
    {{ getMaintenancePlanName(scope.row.maintenancePlanId) }}
  </template>
</el-table-column>
```

#### 2.2 脚本部分修改
**添加导入**:
```typescript
import { MaintenanceOrderApi, MaintenanceOrder } from '@/api/coal/maintenanceorder'
import { MaintenancePlanApi, MaintenancePlan } from '@/api/coal/maintenanceplan'
```

**添加数据列表**:
```typescript
// 检修单列表
const maintenanceOrderList = ref<MaintenanceOrder[]>([])
// 维护计划列表
const maintenancePlanList = ref<MaintenancePlan[]>([])
```

**添加名称获取函数**:
```typescript
/** 获取检修单名称 */
const getMaintenanceOrderName = (workOrderId: number) => {
  if (!workOrderId) return '-'
  const order = maintenanceOrderList.value.find(item => item.id === workOrderId)
  return order ? order.orderCode : `检修单ID: ${workOrderId}`
}

/** 获取维护计划名称 */
const getMaintenancePlanName = (planId: number) => {
  if (!planId) return '-'
  const plan = maintenancePlanList.value.find(item => item.id === planId)
  return plan ? plan.planName : `计划ID: ${planId}`
}
```

**添加获取函数**:
```typescript
/** 获取检修单列表 */
const getMaintenanceOrderList = async () => {
  try {
    const data = await MaintenanceOrderApi.getMaintenanceOrderPage({ pageNo: 1, pageSize: 100 })
    maintenanceOrderList.value = data.list || []
  } catch (error) {
    console.error('获取检修单列表失败:', error)
  }
}

/** 获取维护计划列表 */
const getMaintenancePlanList = async () => {
  try {
    const data = await MaintenancePlanApi.getMaintenancePlanPage({ pageNo: 1, pageSize: 100 })
    maintenancePlanList.value = data.list || []
  } catch (error) {
    console.error('获取维护计划列表失败:', error)
  }
}
```

**修改页面初始化逻辑**:
```typescript
onMounted(() => {
  // 处理从其他页面传递过来的查询参数
  const route = useRoute()
  if (route.query.workOrderId) {
    queryParams.workOrderId = Number(route.query.workOrderId)
  }
  if (route.query.equipmentId) {
    queryParams.equipmentId = Number(route.query.equipmentId)
  }
  
  // 并行加载所有基础数据
  Promise.all([
    getSparePartList(),
    getUserList(),
    getMaintenanceOrderList(),
    getMaintenancePlanList()
  ]).then(() => {
    // 基础数据加载完成后再获取列表数据
    getList()
  })
})
```

## 功能特性

### 1. 下拉选择功能
- **检修单选择**: 显示检修单编号 (`orderCode`)，传递检修单ID
- **维护计划选择**: 显示维护计划名称 (`planName`)，传递计划ID
- **支持搜索**: 两个下拉框都支持 `filterable` 搜索功能
- **支持清空**: 两个下拉框都支持 `clearable` 清空功能

### 2. 列表显示功能
- **检修单列**: 显示检修单编号，如果找不到则显示 `检修单ID: ${workOrderId}`
- **维护计划列**: 显示维护计划名称，如果找不到则显示 `计划ID: ${planId}`
- **空值处理**: 如果ID为空，显示 `-`

### 3. 数据加载优化
- **并行加载**: 使用 `Promise.all()` 并行加载所有基础数据
- **加载顺序**: 先加载基础数据，再加载列表数据，确保显示正确
- **错误处理**: 每个获取函数都有错误处理，避免单个失败影响整体

## 技术要点

### 1. 前端技术
- **Vue 3 Composition API**: 使用 `ref` 和 `reactive` 管理状态
- **Element Plus**: 使用 `el-select` 和 `el-option` 实现下拉选择
- **异步数据加载**: 使用 `async/await` 和 `Promise.all()` 优化加载性能
- **数据映射**: 使用 `find()` 方法实现ID到名称的映射

### 2. 用户体验
- **搜索功能**: 下拉框支持输入搜索，提高选择效率
- **清空功能**: 支持清空选择，提供灵活性
- **友好显示**: 列表显示名称而不是ID，提高可读性
- **错误处理**: 找不到数据时显示友好的提示信息

## 测试验证

### 测试步骤
1. 进入备件使用记录页面
2. 点击"新增"按钮，验证下拉选择功能
3. 选择检修单和维护计划，验证数据传递
4. 保存后查看列表，验证显示是否正确
5. 编辑现有记录，验证数据回显是否正确

### 预期结果
- ✅ 新增/编辑时能正确选择检修单和维护计划
- ✅ 选择的数据能正确保存到数据库
- ✅ 列表能正确显示检修单编号和维护计划名称
- ✅ 从检修单页面跳转过来时能正确筛选数据
- ✅ 所有下拉选择都支持搜索和清空功能

## 总结

通过这次修改，备件使用记录页面现在能够：
1. 通过下拉选择关联检修单和维护计划
2. 在列表中友好地显示关联信息
3. 支持从检修单页面跳转并自动筛选
4. 提供良好的用户体验和错误处理

这完善了备件使用记录与其他模块的关联关系，提升了系统的整体功能性和用户体验。
