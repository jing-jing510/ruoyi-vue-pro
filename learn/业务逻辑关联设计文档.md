# 业务逻辑关联设计文档

## 1. 核心业务流程

### 1.1 计划性检修流程
```
检修计划 → 检修单 → 备件使用记录 → 备件库存更新
```

### 1.2 故障报修流程
```
报修单 → 检修单 → 备件使用记录 → 备件库存更新
```

### 1.3 完整业务流程图
```
检修计划 ──┐
           ├──→ 检修单 ──→ 备件使用记录 ──→ 备件库存更新
报修单 ────┘
```

## 2. 数据表关联关系

### 2.1 检修计划 (maintenance_plan)
- **主键**: `id` (计划ID)
- **关联字段**:
  - `equipment_id` → 设备档案表
  - `responsible_person` → 系统用户表
  - `approver_id` → 系统用户表

### 2.2 报修单 (repair_request)
- **主键**: `id` (报修单ID)
- **关联字段**: 
  - `equipment_id` → 设备档案表
  - `reporter_id` → 系统用户表

### 2.3 检修单 (maintenance_order)
- **主键**: `id` (检修单ID)
- **关联字段**:
  - `plan_id` → 检修计划表 (计划性检修)
  - `equipment_id` → 设备档案表
  - `responsible_person` → 系统用户表
  - **建议新增**: `repair_request_id` → 报修单表 (故障性检修)

### 2.4 备件使用记录 (spare_part_usage_record)
- **主键**: `id` (使用记录ID)
- **关联字段**:
  - `spare_part_id` → 备件信息表
  - `equipment_id` → 设备档案表
  - `work_order_id` → 检修单表 (关联检修单)
  - `fault_id` → 报修单表 (关联报修单)
  - `operator_id` → 系统用户表
  - `supervisor_id` → 系统用户表

## 3. 业务逻辑实现

### 3.1 检修计划 → 检修单 (计划性检修)
- 当检修计划状态变为"已审批"时，可以创建检修单
- 检修单的 `plan_id` 字段关联检修计划ID
- 检修单继承检修计划的设备信息、检修内容等

### 3.2 报修单 → 检修单 (故障性检修)
- 当报修单状态变为"已派单"时，自动创建检修单
- 检修单的 `repair_request_id` 字段关联报修单ID
- 检修单继承报修单的设备信息、故障描述等

### 3.3 检修单 → 备件使用记录
- 在检修单执行过程中，记录使用的备件
- 备件使用记录的 `work_order_id` 关联检修单ID
- 备件使用记录的 `fault_id` 关联原始报修单ID (如果是故障性检修)
- 备件使用记录的 `maintenance_plan_id` 关联检修计划ID (如果是计划性检修)

### 3.4 备件库存自动更新
- 当备件使用记录创建时，自动扣减备件库存
- 当备件使用记录删除时，自动恢复备件库存
- 触发备件预警检查

## 4. 需要修改的数据库表

### 4.1 检修单表 (coal_maintenance_order)
```sql
ALTER TABLE coal_maintenance_order 
ADD COLUMN repair_request_id BIGINT COMMENT '关联报修单ID' AFTER plan_id;
```

### 4.2 备件使用记录表 (coal_spare_part_usage_record)
- 确认 `work_order_id` 字段关联检修单
- 确认 `fault_id` 字段关联报修单

## 5. 前端页面修改

### 5.1 检修计划页面
- 添加"生成检修单"按钮
- 显示关联的检修单列表

### 5.2 报修单页面
- 添加"生成检修单"按钮
- 显示关联的检修单列表

### 5.3 检修单页面
- 显示关联的检修计划或报修单信息
- 添加备件使用记录管理
- 区分计划性检修和故障性检修

### 5.4 备件使用记录页面
- 显示关联的检修单、检修计划、报修单信息
- 支持从检修单页面直接添加备件使用记录
- 区分计划性使用和故障性使用

## 6. 实现步骤

1. **数据库修改**: 添加检修单表的关联字段
2. **后端API修改**: 更新相关接口和业务逻辑
3. **前端页面修改**: 实现关联显示和操作
4. **业务逻辑实现**: 实现自动创建和库存更新
5. **测试验证**: 验证完整的业务流程

## 7. 注意事项

- 确保数据一致性，避免循环引用
- 考虑删除操作的影响，需要级联处理
- 添加必要的权限控制
- 记录操作日志，便于追踪
