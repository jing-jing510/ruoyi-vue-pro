# 检修单关联报修单功能实现总结

## 已完成的工作

### 1. 数据库表结构更新
- **SQL文件**: `learn/检修单表添加关联报修单字段.sql`
- **操作**: 为 `coal_maintenance_order` 表添加 `repair_request_id` 字段
- **字段类型**: `bigint DEFAULT NULL COMMENT '关联报修单ID'`
- **索引**: 添加了 `idx_repair_request_id` 索引以提高查询性能

### 2. 后端代码更新

#### 2.1 DO实体类更新
- **文件**: `MaintenanceOrderDO.java`
- **添加字段**: `repairRequestId` (Long类型)

#### 2.2 VO类更新
- **MaintenanceOrderSaveReqVO.java**: 添加 `repairRequestId` 字段，用于新增/修改请求
- **MaintenanceOrderRespVO.java**: 添加 `repairRequestId` 字段，用于响应数据
- **MaintenanceOrderPageReqVO.java**: 添加 `repairRequestId` 字段，用于分页查询条件

### 3. 前端代码更新

#### 3.1 API接口更新
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/api/coal/maintenanceorder/index.ts`
- **更新**: `MaintenanceOrder` 接口添加 `repairRequestId?: number` 字段

#### 3.2 表单页面更新
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceorder/MaintenanceOrderForm.vue`
- **添加功能**:
  - 关联报修单下拉选择框（显示报修单编号，传递报修单ID）
  - 获取报修单列表的API调用
  - 表单数据中包含 `repairRequestId` 字段

#### 3.3 列表页面更新
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceorder/index.vue`
- **添加功能**:
  - 关联报修单列显示（显示报修单编号）
  - 获取报修单列表的API调用
  - 报修单编号显示函数

## 需要执行的步骤

### 1. 数据库更新
请执行以下SQL语句：
```sql
-- 1. 添加 repair_request_id 字段
ALTER TABLE `coal_maintenance_order` 
ADD COLUMN `repair_request_id` bigint DEFAULT NULL COMMENT '关联报修单ID' AFTER `plan_id`;

-- 2. 添加索引以提高查询性能
CREATE INDEX `idx_repair_request_id` ON `coal_maintenance_order` (`repair_request_id`);
```

### 2. 后端重新编译
由于修改了DO和VO类，需要重新编译后端代码。

### 3. 前端功能验证
- 检修单新增/修改时可以选择关联报修单
- 检修单列表可以显示关联的报修单编号
- 下拉选择框正确显示报修单编号，传递报修单ID

## 业务逻辑说明

### 关联关系
- **检修单** 可以关联 **检修计划** (计划性检修)
- **检修单** 可以关联 **报修单** (故障性检修)
- 一个检修单只能关联一个计划或一个报修单，不能同时关联

### 使用场景
1. **计划性检修**: 从检修计划创建检修单，关联 `planId`
2. **故障性检修**: 从报修单创建检修单，关联 `repairRequestId`

## 下一步计划

1. **实现报修单到检修单的流程**: 在报修单页面添加"生成检修单"按钮
2. **实现检修单到备件使用记录的流程**: 在检修单页面添加备件使用记录管理
3. **完善业务逻辑**: 实现完整的设备维护流程闭环

## 注意事项

- 所有修改都遵循芋道开源框架的规范
- 前端使用下拉选择框显示编号，传递ID值
- 数据库字段为可选字段，允许为空
- 保持了原有功能的完整性，只是扩展了新功能
