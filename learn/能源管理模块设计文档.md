# 能源管理模块设计文档

## 1. 模块概述

能源管理模块是选煤厂生产管理系统的重要组成部分，负责对水、电、剂、介、油等能源消耗进行记录、统计和分析。该模块支持实时数据采集和人工录入，为能源成本控制和生产优化提供数据支持。

## 2. 业务流程

### 2.1 能源数据采集流程
```
数据源 → 数据采集 → 数据验证 → 数据存储 → 统计分析 → 报表生成
```

### 2.2 能源消耗分析流程
```
历史数据 → 趋势分析 → 异常检测 → 预警推送 → 优化建议
```

## 3. 数据库设计

### 3.1 能源类型配置表 (coal_energy_type) - 单表
```sql
DROP TABLE IF EXISTS `coal_energy_type`;
CREATE TABLE `coal_energy_type` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '能源类型ID',
    `type_code` VARCHAR(20) NOT NULL COMMENT '能源类型编码',
    `type_name` VARCHAR(50) NOT NULL COMMENT '能源类型名称',
    `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
    `unit_price` DECIMAL(10,4) DEFAULT NULL COMMENT '单价(元/单位)',
    `is_real_time` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否实时采集：1是 0否',
    `data_source` VARCHAR(50) DEFAULT NULL COMMENT '数据来源：PLC/人工录入',
    `collection_interval` INT DEFAULT NULL COMMENT '采集间隔(分钟)',
    `warning_threshold` DECIMAL(10,2) DEFAULT NULL COMMENT '预警阈值',
    `sort` INT NOT NULL DEFAULT 0 COMMENT '排序',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0禁用 1启用',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_type_code` (`type_code`, `deleted`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '能源类型配置表';
```

### 3.2 能源消耗记录表 (coal_energy_consumption) - 单表
```sql
DROP TABLE IF EXISTS `coal_energy_consumption`;
CREATE TABLE `coal_energy_consumption` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '消耗记录ID',
    `record_code` VARCHAR(50) NOT NULL COMMENT '记录编号',
    `energy_type_id` BIGINT NOT NULL COMMENT '能源类型ID',
    `consumption_date` DATE NOT NULL COMMENT '消耗日期',
    `shift_id` BIGINT DEFAULT NULL COMMENT '班次ID',
    `consumption_value` DECIMAL(12,4) NOT NULL COMMENT '消耗量',
    `unit_cost` DECIMAL(10,4) DEFAULT NULL COMMENT '单位成本(元/单位)',
    `total_cost` DECIMAL(12,2) DEFAULT NULL COMMENT '总成本(元)',
    `data_source` TINYINT NOT NULL DEFAULT 1 COMMENT '数据来源：1实时采集 2人工录入',
    `collection_time` DATETIME DEFAULT NULL COMMENT '采集时间',
    `recorder_id` BIGINT DEFAULT NULL COMMENT '记录人ID',
    `recorder_name` VARCHAR(50) DEFAULT NULL COMMENT '记录人姓名',
    `verification_status` TINYINT NOT NULL DEFAULT 1 COMMENT '验证状态：1待验证 2已验证 3异常',
    `verifier_id` BIGINT DEFAULT NULL COMMENT '验证人ID',
    `verification_time` DATETIME DEFAULT NULL COMMENT '验证时间',
    `verification_remark` VARCHAR(500) DEFAULT NULL COMMENT '验证备注',
    `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
    `creator` VARCHAR(64) DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_record_code` (`record_code`, `deleted`) USING BTREE,
    INDEX `idx_energy_type` (`energy_type_id`) USING BTREE,
    INDEX `idx_consumption_date` (`consumption_date`) USING BTREE,
    INDEX `idx_shift` (`shift_id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '能源消耗记录表';
```

### 3.3 能源消耗统计表 (coal_energy_statistics) - 单表
```sql
DROP TABLE IF EXISTS `coal_energy_statistics`;
CREATE TABLE `coal_energy_statistics` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '统计ID',
    `statistics_date` DATE NOT NULL COMMENT '统计日期',
    `statistics_type` TINYINT NOT NULL COMMENT '统计类型：1日统计 2月统计 3年统计 4班统计',
    `energy_type_id` BIGINT NOT NULL COMMENT '能源类型ID',
    `total_consumption` DECIMAL(12,4) NOT NULL COMMENT '总消耗量',
    `total_cost` DECIMAL(12,2) NOT NULL COMMENT '总成本(元)',
    `average_consumption` DECIMAL(10,4) DEFAULT NULL COMMENT '平均消耗量',
    `peak_consumption` DECIMAL(10,4) DEFAULT NULL COMMENT '峰值消耗量',
    `valley_consumption` DECIMAL(10,4) DEFAULT NULL COMMENT '谷值消耗量',
    `consumption_efficiency` DECIMAL(5,2) DEFAULT NULL COMMENT '消耗效率(%)',
    `cost_per_unit` DECIMAL(10,4) DEFAULT NULL COMMENT '单位成本(元/单位)',
    `comparison_with_plan` DECIMAL(5,2) DEFAULT NULL COMMENT '与计划对比(%)',
    `comparison_with_last_period` DECIMAL(5,2) DEFAULT NULL COMMENT '与上期对比(%)',
    `statistics_status` TINYINT NOT NULL DEFAULT 1 COMMENT '统计状态：1正常 2异常 3需关注',
    `creator` VARCHAR(64) DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_statistics` (`statistics_date`, `statistics_type`, `energy_type_id`, `deleted`) USING BTREE,
    INDEX `idx_energy_type` (`energy_type_id`) USING BTREE,
    INDEX `idx_statistics_date` (`statistics_date`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '能源消耗统计表';
```

### 3.4 能源预警记录表 (coal_energy_alert) - 单表
```sql
DROP TABLE IF EXISTS `coal_energy_alert`;
CREATE TABLE `coal_energy_alert` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '预警ID',
    `alert_code` VARCHAR(50) NOT NULL COMMENT '预警编号',
    `energy_type_id` BIGINT NOT NULL COMMENT '能源类型ID',
    `alert_type` TINYINT NOT NULL COMMENT '预警类型：1消耗异常 2成本超支 3效率低下 4设备故障',
    `alert_level` TINYINT NOT NULL DEFAULT 1 COMMENT '预警级别：1低 2中 3高',
    `alert_title` VARCHAR(100) NOT NULL COMMENT '预警标题',
    `alert_content` TEXT NOT NULL COMMENT '预警内容',
    `current_value` DECIMAL(12,4) DEFAULT NULL COMMENT '当前值',
    `threshold_value` DECIMAL(12,4) DEFAULT NULL COMMENT '阈值',
    `deviation_rate` DECIMAL(5,2) DEFAULT NULL COMMENT '偏差率(%)',
    `alert_time` DATETIME NOT NULL COMMENT '预警时间',
    `alert_status` TINYINT NOT NULL DEFAULT 1 COMMENT '预警状态：1待处理 2处理中 3已处理 4已忽略',
    `handler_id` BIGINT DEFAULT NULL COMMENT '处理人ID',
    `handler_name` VARCHAR(50) DEFAULT NULL COMMENT '处理人姓名',
    `handle_time` DATETIME DEFAULT NULL COMMENT '处理时间',
    `handle_result` TEXT DEFAULT NULL COMMENT '处理结果',
    `handle_remark` VARCHAR(500) DEFAULT NULL COMMENT '处理备注',
    `creator` VARCHAR(64) DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `uk_alert_code` (`alert_code`, `deleted`) USING BTREE,
    INDEX `idx_energy_type` (`energy_type_id`) USING BTREE,
    INDEX `idx_alert_type` (`alert_type`) USING BTREE,
    INDEX `idx_alert_status` (`alert_status`) USING BTREE,
    INDEX `idx_alert_time` (`alert_time`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '能源预警记录表';
```

## 4. 字典配置

### 4.1 能源类型字典
```sql
-- 能源类型字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源类型', 'coal_energy_type', 0, '能源类型', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '电力', '1', 'coal_energy_type', 0, '1', NOW(), '1', NOW()),
(2, '水资源', '2', 'coal_energy_type', 0, '1', NOW(), '1', NOW()),
(3, '药剂', '3', 'coal_energy_type', 0, '1', NOW(), '1', NOW()),
(4, '介质', '4', 'coal_energy_type', 0, '1', NOW(), '1', NOW()),
(5, '燃油', '5', 'coal_energy_type', 0, '1', NOW(), '1', NOW());
```

### 4.2 能源数据来源字典
```sql
-- 能源数据来源字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源数据来源', 'coal_energy_data_source', 0, '能源数据来源', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '实时采集', '1', 'coal_energy_data_source', 0, '1', NOW(), '1', NOW()),
(2, '人工录入', '2', 'coal_energy_data_source', 0, '1', NOW(), '1', NOW());
```

### 4.3 能源验证状态字典
```sql
-- 能源验证状态字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源验证状态', 'coal_energy_verification_status', 0, '能源验证状态', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '待验证', '1', 'coal_energy_verification_status', 0, '1', NOW(), '1', NOW()),
(2, '已验证', '2', 'coal_energy_verification_status', 0, '1', NOW(), '1', NOW()),
(3, '异常', '3', 'coal_energy_verification_status', 0, '1', NOW(), '1', NOW());
```

### 4.4 能源统计类型字典
```sql
-- 能源统计类型字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源统计类型', 'coal_energy_statistics_type', 0, '能源统计类型', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '日统计', '1', 'coal_energy_statistics_type', 0, '1', NOW(), '1', NOW()),
(2, '月统计', '2', 'coal_energy_statistics_type', 0, '1', NOW(), '1', NOW()),
(3, '年统计', '3', 'coal_energy_statistics_type', 0, '1', NOW(), '1', NOW()),
(4, '班统计', '4', 'coal_energy_statistics_type', 0, '1', NOW(), '1', NOW());
```

### 4.5 能源统计状态字典
```sql
-- 能源统计状态字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源统计状态', 'coal_energy_statistics_status', 0, '能源统计状态', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '正常', '1', 'coal_energy_statistics_status', 0, '1', NOW(), '1', NOW()),
(2, '异常', '2', 'coal_energy_statistics_status', 0, '1', NOW(), '1', NOW()),
(3, '需关注', '3', 'coal_energy_statistics_status', 0, '1', NOW(), '1', NOW());
```

### 4.6 能源预警类型字典
```sql
-- 能源预警类型字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源预警类型', 'coal_energy_alert_type', 0, '能源预警类型', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '消耗异常', '1', 'coal_energy_alert_type', 0, '1', NOW(), '1', NOW()),
(2, '成本超支', '2', 'coal_energy_alert_type', 0, '1', NOW(), '1', NOW()),
(3, '效率低下', '3', 'coal_energy_alert_type', 0, '1', NOW(), '1', NOW()),
(4, '设备故障', '4', 'coal_energy_alert_type', 0, '1', NOW(), '1', NOW());
```

### 4.7 能源预警级别字典
```sql
-- 能源预警级别字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源预警级别', 'coal_energy_alert_level', 0, '能源预警级别', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '低', '1', 'coal_energy_alert_level', 0, '1', NOW(), '1', NOW()),
(2, '中', '2', 'coal_energy_alert_level', 0, '1', NOW(), '1', NOW()),
(3, '高', '3', 'coal_energy_alert_level', 0, '1', NOW(), '1', NOW());
```

### 4.8 能源预警状态字典
```sql
-- 能源预警状态字典
INSERT INTO `system_dict_type` (`name`, `type`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES 
('能源预警状态', 'coal_energy_alert_status', 0, '能源预警状态', '1', NOW(), '1', NOW(), 0);

INSERT INTO `system_dict_data` (`sort`, `label`, `value`, `dict_type`, `status`, `creator`, `create_time`, `updater`, `update_time`) VALUES
(1, '待处理', '1', 'coal_energy_alert_status', 0, '1', NOW(), '1', NOW()),
(2, '处理中', '2', 'coal_energy_alert_status', 0, '1', NOW(), '1', NOW()),
(3, '已处理', '3', 'coal_energy_alert_status', 0, '1', NOW(), '1', NOW()),
(4, '已忽略', '4', 'coal_energy_alert_status', 0, '1', NOW(), '1', NOW());
```

## 5. 功能特性

### 5.1 核心功能
- **能源类型管理**：支持水、电、剂、介、油等多种能源类型配置
- **消耗记录管理**：支持实时采集和人工录入两种数据来源
- **统计分析**：提供日、月、年、班等多维度统计分析
- **预警管理**：支持消耗异常、成本超支、效率低下等预警
- **成本控制**：实时计算能源成本，支持成本分析和优化建议

### 5.2 技术特性
- **实时数据采集**：支持PLC数据采集和人工录入
- **数据验证**：支持数据验证和异常检测
- **统计分析**：自动生成统计报表和趋势分析
- **预警推送**：支持多级预警和消息推送
- **报表导出**：支持Excel、PDF等格式报表导出

## 6. 业务流程卡片

### 6.1 业务流程
```
能源类型配置 → 消耗记录 → 数据验证 → 统计分析 → 预警处理 → 成本优化
```

### 6.2 卡片功能
- 实时显示各类能源消耗情况
- 展示能源成本统计和趋势分析
- 提供预警信息和处理状态
- 支持快速导航到各功能模块

## 7. 开发建议

### 7.1 开发顺序
1. **能源类型配置** - 单表结构，基础数据管理
2. **能源消耗记录** - 单表结构，核心业务功能
3. **能源统计分析** - 单表结构，数据统计功能
4. **能源预警管理** - 单表结构，预警处理功能
5. **业务流程卡片** - 首页展示和快速导航

### 7.2 技术实现
- 使用芋道框架的代码生成器生成基础CRUD功能
- 实现数据采集接口和实时数据处理
- 开发统计分析和报表生成功能
- 集成预警系统和消息推送功能

## 8. 测试数据

### 8.1 能源类型测试数据
```sql
INSERT INTO `coal_energy_type` (`type_code`, `type_name`, `unit`, `unit_price`, `is_real_time`, `data_source`, `collection_interval`, `warning_threshold`, `sort`, `status`, `remark`) VALUES
('ELECTRICITY', '电力', 'kWh', 0.65, 1, 'PLC', 15, 1000.00, 1, 1, '电力消耗实时监控'),
('WATER', '水资源', 'm³', 3.20, 1, 'PLC', 30, 50.00, 2, 1, '水资源消耗监控'),
('CHEMICAL', '药剂', 'kg', 15.00, 0, '人工录入', NULL, 100.00, 3, 1, '药剂消耗人工记录'),
('MEDIUM', '介质', 't', 200.00, 0, '人工录入', NULL, 10.00, 4, 1, '介质消耗人工记录'),
('FUEL', '燃油', 'L', 6.50, 0, '人工录入', NULL, 500.00, 5, 1, '燃油消耗人工记录');
```

### 8.2 能源消耗记录测试数据
```sql
INSERT INTO `coal_energy_consumption` (`record_code`, `energy_type_id`, `consumption_date`, `shift_id`, `consumption_value`, `unit_cost`, `total_cost`, `data_source`, `collection_time`, `recorder_id`, `recorder_name`, `verification_status`, `remark`) VALUES
('EC20250101001', 1, '2025-01-01', 1, 1250.50, 0.65, 812.83, 1, '2025-01-01 08:00:00', NULL, NULL, 2, '早班电力消耗'),
('EC20250101002', 2, '2025-01-01', 1, 45.20, 3.20, 144.64, 1, '2025-01-01 08:00:00', NULL, NULL, 2, '早班水资源消耗'),
('EC20250101003', 3, '2025-01-01', 1, 85.50, 15.00, 1282.50, 2, '2025-01-01 08:30:00', 1, '张三', 1, '早班药剂消耗'),
('EC20250101004', 4, '2025-01-01', 1, 8.50, 200.00, 1700.00, 2, '2025-01-01 08:30:00', 1, '张三', 1, '早班介质消耗'),
('EC20250101005', 5, '2025-01-01', 1, 120.00, 6.50, 780.00, 2, '2025-01-01 08:30:00', 1, '张三', 1, '早班燃油消耗');
```

## 9. 总结

能源管理模块是选煤厂生产管理系统的重要组成部分，通过系统化的能源数据管理，能够有效控制能源成本，提高能源利用效率，为生产决策提供数据支持。该模块设计合理，功能完善，能够满足选煤厂能源管理的实际需求。
