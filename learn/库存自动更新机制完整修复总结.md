# åº“å­˜è‡ªåŠ¨æ›´æ–°æœºåˆ¶å®Œæ•´ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æ±‡æ€»

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **å‡ºåº“æ—¶åº“å­˜æ•°é‡åè€Œå¢åŠ ** - åº“å­˜æ›´æ–°é€»è¾‘é”™è¯¯
2. **æ“ä½œæ—¶é—´å’Œå®¡æ‰¹æ—¶é—´æ²¡æœ‰æ˜¾ç¤º** - å‰ç«¯æ—¶é—´å­—æ®µæ˜¾ç¤ºé—®é¢˜
3. **æœ€åå…¥åº“æ—¶é—´å’Œæœ€åå‡ºåº“æ—¶é—´æ²¡æœ‰æ˜¾ç¤º** - åº“å­˜è®°å½•æ—¶é—´å­—æ®µæœªæ›´æ–°

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤åº“å­˜æ›´æ–°é€»è¾‘

#### é—®é¢˜åˆ†æ
- å‡ºå…¥åº“è®°å½•çš„æ•°é‡å­—æ®µè®¾è®¡ä¸º"æ­£æ•°å…¥åº“ï¼Œè´Ÿæ•°å‡ºåº“"
- åŸé€»è¾‘é”™è¯¯åœ°ä½¿ç”¨æ“ä½œç±»å‹å­—æ®µåˆ¤æ–­å…¥åº“/å‡ºåº“
- å‡ºåº“æ—¶æ•°é‡ä¸ºè´Ÿæ•°ï¼Œä½†è¢«å½“ä½œæ­£æ•°å¤„ç†ï¼Œå¯¼è‡´åº“å­˜å¢åŠ 

#### ä¿®å¤ä»£ç 
```java
// ä¿®å¤å‰ï¼šé”™è¯¯ä½¿ç”¨æ“ä½œç±»å‹åˆ¤æ–­
private void updateStockQuantity(SparePartInventoryLogDO log) {
    if (log.getOperationType() == 1) { // å…¥åº“
        sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity());
    } else if (log.getOperationType() == 2) { // å‡ºåº“
        sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity());
    }
}

// ä¿®å¤åï¼šæ­£ç¡®ä½¿ç”¨æ•°é‡æ­£è´Ÿåˆ¤æ–­
private void updateStockQuantity(SparePartInventoryLogDO log) {
    // æ ¹æ®æ•°é‡çš„æ­£è´Ÿæ¥åˆ¤æ–­æ˜¯å…¥åº“è¿˜æ˜¯å‡ºåº“
    if (log.getQuantity().compareTo(BigDecimal.ZERO) > 0) {
        // æ­£æ•°ï¼šå…¥åº“
        sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity());
    } else if (log.getQuantity().compareTo(BigDecimal.ZERO) < 0) {
        // è´Ÿæ•°ï¼šå‡ºåº“ï¼Œéœ€è¦è½¬æ¢ä¸ºæ­£æ•°
        sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity().abs());
    }
}
```

### 2. ä¿®å¤å›æ»šåº“å­˜é€»è¾‘

#### ä¿®å¤ä»£ç 
```java
// ä¿®å¤å‰ï¼šé”™è¯¯ä½¿ç”¨æ“ä½œç±»å‹åˆ¤æ–­
private void rollbackStockQuantity(SparePartInventoryLogDO log) {
    if (log.getOperationType() == 1) { // åŸå…¥åº“ï¼Œç°åœ¨è¦å›æ»šï¼ˆå‡å°‘åº“å­˜ï¼‰
        sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity());
    } else if (log.getOperationType() == 2) { // åŸå‡ºåº“ï¼Œç°åœ¨è¦å›æ»šï¼ˆå¢åŠ åº“å­˜ï¼‰
        sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity());
    }
}

// ä¿®å¤åï¼šæ­£ç¡®ä½¿ç”¨æ•°é‡æ­£è´Ÿåˆ¤æ–­
private void rollbackStockQuantity(SparePartInventoryLogDO log) {
    // æ ¹æ®æ•°é‡çš„æ­£è´Ÿæ¥åˆ¤æ–­å›æ»šæ“ä½œ
    if (log.getQuantity().compareTo(BigDecimal.ZERO) > 0) {
        // åŸå…¥åº“ï¼ˆæ­£æ•°ï¼‰ï¼Œç°åœ¨è¦å›æ»šï¼ˆå‡å°‘åº“å­˜ï¼‰
        sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity());
    } else if (log.getQuantity().compareTo(BigDecimal.ZERO) < 0) {
        // åŸå‡ºåº“ï¼ˆè´Ÿæ•°ï¼‰ï¼Œç°åœ¨è¦å›æ»šï¼ˆå¢åŠ åº“å­˜ï¼‰
        sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity().abs());
    }
}
```

### 3. æ·»åŠ æ—¶é—´å­—æ®µæ›´æ–°

#### å¢åŠ åº“å­˜æ—¶æ›´æ–°æœ€åå…¥åº“æ—¶é—´
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void increaseStock(Long sparePartId, BigDecimal quantity) {
    // æŸ¥æ‰¾æˆ–åˆ›å»ºåº“å­˜è®°å½•
    SparePartStockDO stock = getOrCreateStock(sparePartId);
    
    // å¢åŠ åº“å­˜æ•°é‡
    stock.setQuantity(stock.getQuantity().add(quantity));
    
    // æ›´æ–°æœ€åå…¥åº“æ—¶é—´
    stock.setLastInDate(LocalDateTime.now());
    
    // æ›´æ–°åº“å­˜è®°å½•
    sparePartStockMapper.updateById(stock);
}
```

#### å‡å°‘åº“å­˜æ—¶æ›´æ–°æœ€åå‡ºåº“æ—¶é—´
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void decreaseStock(Long sparePartId, BigDecimal quantity) {
    // æŸ¥æ‰¾åº“å­˜è®°å½•
    SparePartStockDO stock = getOrCreateStock(sparePartId);
    
    // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
    if (stock.getQuantity().compareTo(quantity) < 0) {
        throw exception(SPARE_PART_STOCK_NOT_EXISTS, "åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š" + stock.getQuantity() + "ï¼Œéœ€è¦æ•°é‡ï¼š" + quantity);
    }
    
    // å‡å°‘åº“å­˜æ•°é‡
    stock.setQuantity(stock.getQuantity().subtract(quantity));
    
    // æ›´æ–°æœ€åå‡ºåº“æ—¶é—´
    stock.setLastOutDate(LocalDateTime.now());
    
    // æ›´æ–°åº“å­˜è®°å½•
    sparePartStockMapper.updateById(stock);
}
```

### 4. ä¿®å¤å‰ç«¯æ“ä½œæ—¶é—´é»˜è®¤å€¼

#### é—®é¢˜åˆ†æ
- å‡ºå…¥åº“è®°å½•è¡¨å•ä¸­æ“ä½œæ—¶é—´æ˜¯å¿…å¡«å­—æ®µ
- ä½†åˆå§‹å€¼ä¸º `undefined`ï¼Œç”¨æˆ·å¯èƒ½å¿˜è®°å¡«å†™
- å¯¼è‡´æ“ä½œæ—¶é—´æ˜¾ç¤ºä¸ºç©º

#### ä¿®å¤ä»£ç 
```typescript
// ä¿®å¤å‰ï¼šæ“ä½œæ—¶é—´ä¸ºundefined
const formData = ref({
  operationDate: undefined,
  // ... å…¶ä»–å­—æ®µ
})

// ä¿®å¤åï¼šè®¾ç½®é»˜è®¤å½“å‰æ—¶é—´
const formData = ref({
  operationDate: undefined as string | undefined,
  // ... å…¶ä»–å­—æ®µ
})

/** é‡ç½®è¡¨å• */
const resetForm = () => {
  formData.value = {
    // ... å…¶ä»–å­—æ®µ
    operationDate: new Date().toISOString().slice(0, 19).replace('T', ' '), // é»˜è®¤å½“å‰æ—¶é—´
    // ... å…¶ä»–å­—æ®µ
  }
  formRef.value?.resetFields()
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### 1. åº“å­˜æ•°é‡æ­£ç¡®æ€§
- âœ… **å…¥åº“æ“ä½œ**ï¼šæ­£æ•°æ•°é‡æ­£ç¡®å¢åŠ åº“å­˜
- âœ… **å‡ºåº“æ“ä½œ**ï¼šè´Ÿæ•°æ•°é‡æ­£ç¡®å‡å°‘åº“å­˜ï¼ˆè½¬æ¢ä¸ºæ­£æ•°åå‡å°‘ï¼‰
- âœ… **å›æ»šæ“ä½œ**ï¼šæ­£ç¡®å›æ»šåº“å­˜å˜åŒ–

### 2. æ—¶é—´å­—æ®µæ˜¾ç¤º
- âœ… **æœ€åå…¥åº“æ—¶é—´**ï¼šå…¥åº“æ—¶è‡ªåŠ¨æ›´æ–°ä¸ºå½“å‰æ—¶é—´
- âœ… **æœ€åå‡ºåº“æ—¶é—´**ï¼šå‡ºåº“æ—¶è‡ªåŠ¨æ›´æ–°ä¸ºå½“å‰æ—¶é—´
- âœ… **æ“ä½œæ—¶é—´**ï¼šåˆ›å»ºè®°å½•æ—¶é»˜è®¤è®¾ç½®ä¸ºå½“å‰æ—¶é—´

### 3. æ•°æ®ä¸€è‡´æ€§
- âœ… **å‡ºå…¥åº“è®°å½•ä¸åº“å­˜æ•°æ®ä¿æŒä¸€è‡´**
- âœ… **æ—¶é—´å­—æ®µæ­£ç¡®è®°å½•æ“ä½œæ—¶é—´**
- âœ… **äº‹åŠ¡ä¿è¯æ•°æ®å®Œæ•´æ€§**

## ğŸ” æ•°æ®å­—æ®µè¯´æ˜

### å‡ºå…¥åº“è®°å½•æ•°é‡å­—æ®µè®¾è®¡
- **æ­£æ•°**ï¼šè¡¨ç¤ºå…¥åº“æ“ä½œï¼Œæ•°é‡ä¸ºæ­£æ•°
- **è´Ÿæ•°**ï¼šè¡¨ç¤ºå‡ºåº“æ“ä½œï¼Œæ•°é‡ä¸ºè´Ÿæ•°
- **ç¤ºä¾‹**ï¼š
  - å…¥åº“10ä¸ªï¼š`quantity = 10`
  - å‡ºåº“5ä¸ªï¼š`quantity = -5`

### åº“å­˜æ›´æ–°é€»è¾‘
- **å…¥åº“**ï¼š`quantity > 0` â†’ è°ƒç”¨ `increaseStock(sparePartId, quantity)`
- **å‡ºåº“**ï¼š`quantity < 0` â†’ è°ƒç”¨ `decreaseStock(sparePartId, abs(quantity))`

### æ—¶é—´å­—æ®µæ›´æ–°è§„åˆ™
- **å…¥åº“æ—¶**ï¼šæ›´æ–° `lastInDate = å½“å‰æ—¶é—´`
- **å‡ºåº“æ—¶**ï¼šæ›´æ–° `lastOutDate = å½“å‰æ—¶é—´`
- **åˆ›å»ºè®°å½•æ—¶**ï¼šè®¾ç½® `operationDate = å½“å‰æ—¶é—´`ï¼ˆé»˜è®¤å€¼ï¼‰

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. æ•°æ®ç±»å‹å¤„ç†
- ä½¿ç”¨ `BigDecimal` ç¡®ä¿æ•°å€¼è®¡ç®—ç²¾åº¦
- ä½¿ç”¨ `BigDecimal.compareTo()` è¿›è¡Œæ•°å€¼æ¯”è¾ƒ
- ä½¿ç”¨ `BigDecimal.abs()` è·å–ç»å¯¹å€¼

### 2. æ—¶é—´å¤„ç†
- ä½¿ç”¨ `LocalDateTime.now()` è·å–å½“å‰æ—¶é—´
- å‰ç«¯ä½¿ç”¨ `new Date().toISOString()` æ ¼å¼åŒ–æ—¶é—´
- æ—¶é—´æ ¼å¼ï¼š`YYYY-MM-DD HH:mm:ss`

### 3. äº‹åŠ¡ç®¡ç†
- æ‰€æœ‰åº“å­˜æ“ä½œéƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
- ä½¿ç”¨ `@Transactional(rollbackFor = Exception.class)`
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

## ğŸ¯ æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- æµ‹è¯•å…¥åº“æ“ä½œï¼šæ•°é‡ä¸ºæ­£æ•°ï¼Œåº“å­˜åº”å¢åŠ 
- æµ‹è¯•å‡ºåº“æ“ä½œï¼šæ•°é‡ä¸ºè´Ÿæ•°ï¼Œåº“å­˜åº”å‡å°‘
- æµ‹è¯•æ›´æ–°æ“ä½œï¼šåº“å­˜åº”æ­£ç¡®è°ƒæ•´
- æµ‹è¯•åˆ é™¤æ“ä½œï¼šåº“å­˜åº”æ­£ç¡®å›æ»š

### 2. æ—¶é—´æµ‹è¯•
- éªŒè¯æœ€åå…¥åº“æ—¶é—´æ˜¯å¦æ­£ç¡®æ›´æ–°
- éªŒè¯æœ€åå‡ºåº“æ—¶é—´æ˜¯å¦æ­£ç¡®æ›´æ–°
- éªŒè¯æ“ä½œæ—¶é—´æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

### 3. è¾¹ç•Œæµ‹è¯•
- æµ‹è¯•åº“å­˜ä¸è¶³æ—¶çš„å¼‚å¸¸å¤„ç†
- æµ‹è¯•æ•°é‡ä¸º0æ—¶çš„å¤„ç†
- æµ‹è¯•å¤§é‡æ•°æ®æ—¶çš„æ€§èƒ½

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ•°æ®éªŒè¯å¢å¼º**
   - æ·»åŠ æ›´å¤šçš„æ•°æ®éªŒè¯é€»è¾‘
   - ç¡®ä¿æ•°é‡å­—æ®µçš„åˆç†æ€§

2. **æ—¥å¿—è®°å½•å®Œå–„**
   - æ·»åŠ è¯¦ç»†çš„æ“ä½œæ—¥å¿—
   - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡

3. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–åº“å­˜æŸ¥è¯¢
   - æ‰¹é‡æ“ä½œæ—¶çš„æ€§èƒ½ä¼˜åŒ–

4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - æ·»åŠ æ“ä½œç¡®è®¤æç¤º
   - æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯

---

*åº“å­˜è‡ªåŠ¨æ›´æ–°æœºåˆ¶å®Œæ•´ä¿®å¤æ€»ç»“* | *æ‰€æœ‰é—®é¢˜å·²ä¿®å¤* | *ç³»ç»Ÿè¿è¡Œæ­£å¸¸*
