# 备件使用记录设备关联逻辑说明

## 当前实现逻辑

### 1. 搜索栏 - 关联设备
```html
<el-form-item label="关联设备" prop="equipmentId">
  <el-select
    v-model="queryParams.equipmentId"
    placeholder="请选择设备"
    clearable
    filterable
    class="!w-240px"
  >
    <el-option
      v-for="equipment in equipmentList"
      :key="equipment.id"
      :label="equipment.equipmentName"  <!-- 显示设备名称 -->
      :value="equipment.id"             <!-- 传递设备ID -->
    />
  </el-select>
</el-form-item>
```

**逻辑**: 下拉选择显示设备名称，传递设备ID到 `queryParams.equipmentId`

### 2. 列表显示 - 关联设备
```html
<el-table-column label="关联设备" align="center" prop="equipmentId">
  <template #default="scope">
    {{ getEquipmentName(scope.row.equipmentId) }}
  </template>
</el-table-column>
```

**逻辑**: 显示设备名称，但实际存储和传递的是设备ID

### 3. 表单页面 - 关联设备
```html
<el-form-item label="关联设备" prop="equipmentId">
  <el-select v-model="formData.equipmentId" placeholder="请选择设备" clearable filterable>
    <el-option
      v-for="equipment in equipmentList"
      :key="equipment.id"
      :label="equipment.equipmentName"  <!-- 显示设备名称 -->
      :value="equipment.id"             <!-- 传递设备ID -->
    />
  </el-select>
</el-form-item>
```

**逻辑**: 下拉选择显示设备名称，传递设备ID到 `formData.equipmentId`

### 4. 名称获取函数
```typescript
/** 获取设备名称 */
const getEquipmentName = (equipmentId: number) => {
  if (!equipmentId) return '-'
  const equipment = equipmentList.value.find(item => item.id === equipmentId)
  return equipment ? equipment.equipmentName : `设备ID: ${equipmentId}`
}
```

**逻辑**: 根据设备ID查找设备名称，如果找不到则显示 `设备ID: ${equipmentId}`

## 数据流程

### 1. 数据存储
- 数据库中存储的是 `equipment_id` (设备ID)
- 前端 `formData.equipmentId` 和 `queryParams.equipmentId` 存储的是设备ID

### 2. 显示逻辑
- 下拉选择: 显示 `equipment.equipmentName`，传递 `equipment.id`
- 列表显示: 调用 `getEquipmentName(equipmentId)` 显示设备名称
- 表单回显: 根据设备ID自动选中对应的设备名称

### 3. 数据传递
- 搜索: `queryParams.equipmentId` 传递设备ID到后端查询
- 表单提交: `formData.equipmentId` 传递设备ID到后端保存
- 列表显示: 从后端获取设备ID，前端转换为设备名称显示

## 调试信息

已添加调试信息来确认设备列表是否正确加载：

```typescript
/** 获取设备列表 */
const getEquipmentList = async () => {
  try {
    const data = await EquipmentInfoApi.getEquipmentInfoPage({ pageNo: 1, pageSize: 100 })
    equipmentList.value = data.list || []
    console.log('设备列表加载完成:', equipmentList.value.length, '条记录')
  } catch (error) {
    console.error('获取设备列表失败:', error)
  }
}
```

## 测试步骤

1. 打开浏览器开发者工具控制台
2. 进入备件使用记录页面
3. 查看控制台输出，确认设备列表是否正确加载
4. 测试搜索栏的设备下拉选择
5. 测试列表的设备名称显示
6. 测试表单的设备下拉选择

## 预期结果

- 控制台应显示: `设备列表加载完成: X 条记录`
- 搜索栏设备下拉框应显示设备名称列表
- 列表应显示设备名称而不是设备ID
- 表单设备下拉框应显示设备名称列表
- 所有操作传递的参数都应该是设备ID

## 可能的问题

如果设备下拉框显示"数据是无"，可能的原因：

1. **设备列表未加载**: 检查控制台是否有设备列表加载的日志
2. **API调用失败**: 检查控制台是否有获取设备列表失败的错误
3. **数据为空**: 检查数据库中是否有设备数据
4. **API路径错误**: 检查 `EquipmentInfoApi.getEquipmentInfoPage` 是否正确

请按照测试步骤进行测试，并告诉我控制台的输出结果。
