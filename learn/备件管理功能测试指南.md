y# 备件管理功能测试指南

## 📊 测试数据SQL脚本

### 1. 设备档案测试数据
```sql
-- 插入设备分类
INSERT INTO coal_equipment_category (category_name, parent_id, category_level, sort, status, remark) VALUES
('破碎设备', 0, 1, 1, 1, '破碎相关设备'),
('输送设备', 0, 1, 2, 1, '输送相关设备'),
('分选设备', 0, 1, 3, 1, '分选相关设备');

-- 获取分类ID
SET @crushing_category_id = (SELECT id FROM coal_equipment_category WHERE category_name = '破碎设备' LIMIT 1);

-- 插入设备档案
INSERT INTO coal_equipment_info (equipment_code, equipment_name, category_id, model, manufacturer, 
    manufacture_date, install_date, commission_date, asset_number, rated_power, rated_capacity, 
    weight, dimensions, responsible_person_id, maintenance_person_id, operator_person_id, 
    status, health_level, importance_level, remark) VALUES
('PSJ-001', '主破碎机', @crushing_category_id, 'PE-600×900', '山东某重工', 
    '2023-01-15', '2023-03-01', '2023-03-15', 'ZC-2023-001', 75.0, 50.0, 
    8.5, '2400×1560×2800', 1, 1, 1, 
    1, 1, 3, '主要破碎设备，重要程度高'),
('PSJ-002', '副破碎机', @crushing_category_id, 'PE-400×600', '山东某重工', 
    '2023-02-10', '2023-04-01', '2023-04-15', 'ZC-2023-002', 30.0, 25.0, 
    4.2, '1700×1520×1950', 1, 1, 1, 
    1, 2, 2, '备用破碎设备');
```

### 2. 备件信息测试数据
```sql
-- 插入ERP产品分类（备件分类）
INSERT INTO erp_product_category (name, parent_id, code, sort, status) VALUES
('轴承类备件', 0, 'ZC', 1, 0),
('密封件类', 0, 'MF', 2, 0),
('电气件类', 0, 'DQ', 3, 0);

-- 获取分类ID
SET @bearing_category_id = (SELECT id FROM erp_product_category WHERE name = '轴承类备件' LIMIT 1);
SET @seal_category_id = (SELECT id FROM erp_product_category WHERE name = '密封件类' LIMIT 1);

-- 插入ERP产品单位
INSERT INTO erp_product_unit (name, status) VALUES
('个', 0),
('套', 0),
('米', 0);

-- 获取单位ID
SET @unit_piece_id = (SELECT id FROM erp_product_unit WHERE name = '个' LIMIT 1);
SET @unit_set_id = (SELECT id FROM erp_product_unit WHERE name = '套' LIMIT 1);

-- 插入备件信息（扩展ERP产品表）
INSERT INTO erp_product (name, bar_code, category_id, unit_id, status, standard, remark, 
    purchase_price, sale_price, min_price, 
    -- 备件扩展字段
    equipment_id, spare_part_type, min_stock, max_stock, safety_stock, 
    supplier_name, replacement_cycle, last_replacement_date, next_replacement_date) VALUES
('SKF轴承6324', 'BJ001001', @bearing_category_id, @unit_piece_id, 0, '120×260×55mm', '主破碎机主轴承', 
    1200.00, 1500.00, 1100.00,
    -- 备件扩展字段
    (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-001'), 1, 2, 10, 5, 
    'SKF中国有限公司', 180, '2024-06-01', '2024-11-28'),
('NSK轴承6322', 'BJ001002', @bearing_category_id, @unit_piece_id, 0, '110×240×50mm', '副破碎机主轴承', 
    800.00, 1000.00, 750.00,
    (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-002'), 1, 1, 8, 3, 
    'NSK中国有限公司', 150, '2024-05-15', '2024-10-12'),
('橡胶密封圈套装', 'BJ002001', @seal_category_id, @unit_set_id, 0, 'Φ120-Φ260', '破碎机密封圈', 
    150.00, 200.00, 120.00,
    (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-001'), 1, 3, 15, 8, 
    '河北某橡胶厂', 90, '2024-09-01', '2024-11-30');
```

### 3. 仓库和库存测试数据
```sql
-- 插入ERP仓库
INSERT INTO erp_warehouse (name, address, sort, remark, principal, warehouse_price, traceability, status) VALUES
('备件库A区', '选煤厂备件仓库A区', 1, '主要备件存储区域', '仓库管理员', 1, b'1', 0),
('备件库B区', '选煤厂备件仓库B区', 2, '次要备件存储区域', '仓库管理员', 1, b'1', 0);

-- 获取仓库ID
SET @warehouse_a_id = (SELECT id FROM erp_warehouse WHERE name = '备件库A区' LIMIT 1);
SET @warehouse_b_id = (SELECT id FROM erp_warehouse WHERE name = '备件库B区' LIMIT 1);

-- 获取备件ID
SET @bearing_6324_id = (SELECT id FROM erp_product WHERE name = 'SKF轴承6324' LIMIT 1);
SET @bearing_6322_id = (SELECT id FROM erp_product WHERE name = 'NSK轴承6322' LIMIT 1);
SET @seal_set_id = (SELECT id FROM erp_product WHERE name = '橡胶密封圈套装' LIMIT 1);

-- 插入库存记录（模拟当前库存）
INSERT INTO erp_stock (product_id, warehouse_id, count) VALUES
(@bearing_6324_id, @warehouse_a_id, 3.00),  -- 低于安全库存5，会触发预警
(@bearing_6322_id, @warehouse_a_id, 1.00),  -- 低于安全库存3，会触发预警
(@seal_set_id, @warehouse_b_id, 12.00);     -- 高于安全库存8，正常

-- 插入库存记录（用于预警测试）
INSERT INTO erp_stock_record (product_id, warehouse_id, count, total_count, price, total_price, 
    biz_type, biz_id, no, remark) VALUES
(@bearing_6324_id, @warehouse_a_id, 8.00, 8.00, 1200.00, 9600.00, 1, 1, 'RK-2024-001', '初始入库'),
(@bearing_6324_id, @warehouse_a_id, -4.00, 4.00, 1200.00, -4800.00, 2, 1, 'CK-2024-001', '设备维护领用'),
(@bearing_6324_id, @warehouse_a_id, -1.00, 3.00, 1200.00, -1200.00, 2, 2, 'CK-2024-002', '紧急维修领用');
```

### 4. 备件设备关联测试数据
```sql
-- 插入备件设备关联记录
INSERT INTO coal_spare_part_equipment (spare_part_id, equipment_id, is_required, quantity, unit, 
    install_position, replacement_difficulty, remark) VALUES
(@bearing_6324_id, (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-001'), 1, 4.00, '个', 
    '主轴承座', '中等', '每次更换需停机4小时，需要专业技术人员'),
(@bearing_6322_id, (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-002'), 1, 2.00, '个', 
    '主轴承座', '中等', '每次更换需停机2小时'),
(@seal_set_id, (SELECT id FROM coal_equipment_info WHERE equipment_code = 'PSJ-001'), 1, 1.00, '套', 
    '密封腔体', '简单', '定期更换，防止漏油');
```

### 5. 字典数据补充
```sql
-- 确保备件相关字典数据存在
INSERT IGNORE INTO system_dict_type (name, type, status, remark) VALUES
('备件类型', 'spare_part_type', 0, '备件分类：易损件、标准件、电气件等'),
('预警类型', 'alert_type', 0, '预警类型：库存不足、到期更换、超期未更换等'),
('预警级别', 'alert_level', 0, '预警级别：低、中、高'),
('预警状态', 'alert_status', 0, '预警状态：待处理、处理中、已处理、已忽略');

INSERT IGNORE INTO system_dict_data (sort, label, value, dict_type, status, remark) VALUES
-- 备件类型
(1, '易损件', '1', 'spare_part_type', 0, '容易磨损需要定期更换的备件'),
(2, '标准件', '2', 'spare_part_type', 0, '标准化的通用备件'),
(3, '电气件', '3', 'spare_part_type', 0, '电气相关的备件'),
-- 预警类型
(1, '库存不足', '1', 'alert_type', 0, '当前库存低于安全库存'),
(2, '到期更换', '2', 'alert_type', 0, '即将到达更换周期'),
(3, '超期未更换', '3', 'alert_type', 0, '已超过计划更换时间'),
(4, '库存过多', '4', 'alert_type', 0, '当前库存超过最大库存'),
-- 预警级别
(1, '低', '1', 'alert_level', 0, '低级预警'),
(2, '中', '2', 'alert_level', 0, '中等预警'),
(3, '高', '3', 'alert_level', 0, '高级预警'),
-- 预警状态
(1, '待处理', '1', 'alert_status', 0, '预警待处理'),
(2, '处理中', '2', 'alert_status', 0, '预警处理中'),
(3, '已处理', '3', 'alert_status', 0, '预警已处理'),
(4, '已忽略', '4', 'alert_status', 0, '预警已忽略');
```

---

## ✅ 功能完整性检查清单

### 🎯 核心功能模块

#### 1. 设备档案管理 ✅
- [x] **页面路径**: 选煤厂管理 → 设备档案管理
- [x] **基本功能**: 增删改查、树形分类
- [x] **扩展功能**: 二维码生成、文件上传、人员关联
- [x] **数据关联**: 责任人、维护人、操作人显示昵称

#### 2. 备件信息管理 ✅
- [x] **页面路径**: ERP管理 → 产品管理 → 备件管理
- [x] **基本功能**: 增删改查、分页查询
- [x] **备件字段**: 备件类型、关联设备、库存阈值、供应商、更换周期
- [x] **查询过滤**: 按备件类型、关联设备筛选
- [x] **数据关联**: 设备名称、分类名称正确显示

#### 3. 备件设备关联管理 ✅
- [x] **页面路径**: 备件管理 → 设备关联管理
- [x] **后端API**: 完整的CRUD接口
- [x] **前端页面**: 列表查询、表单操作
- [x] **业务逻辑**: 关联关系、用量管理、必需标识
- [x] **数据展示**: 备件名称、设备名称正确显示

#### 4. 备件预警记录管理 ✅
- [x] **页面路径**: 备件管理 → 预警记录管理
- [x] **后端API**: 完整的CRUD和处理接口
- [x] **前端页面**: 列表查询、预警处理表单
- [x] **业务逻辑**: 预警处理、忽略、状态管理
- [x] **自动预警**: 定时任务检查库存和更换周期

#### 5. 库存管理 ✅
- [x] **页面路径**: ERP管理 → 库存管理
- [x] **基本功能**: 直接使用ERP原有功能
- [x] **数据关联**: 与备件信息关联

### 🔧 技术实现检查

#### 后端实现 ✅
- [x] **Controller层**: 所有API接口完整
- [x] **Service层**: 业务逻辑实现
- [x] **Mapper层**: 数据库查询方法
- [x] **DO层**: 实体类定义
- [x] **VO层**: 请求/响应对象
- [x] **定时任务**: 自动预警检查

#### 前端实现 ✅
- [x] **API层**: 前端接口定义
- [x] **页面组件**: 列表、表单、对话框
- [x] **数据绑定**: 字典、关联数据显示
- [x] **交互逻辑**: 增删改查、表单验证
- [x] **路由配置**: 菜单和页面路由

#### 数据库设计 ✅
- [x] **核心表**: 设备档案、备件关联、预警记录
- [x] **扩展表**: ERP产品表扩展备件字段
- [x] **关联关系**: 外键关系正确
- [x] **索引优化**: 查询字段索引
- [x] **字典配置**: 完整的字典类型和数据

### 🎪 业务流程验证

#### 完整业务场景测试
1. **✅ 设备录入** → 创建设备档案
2. **✅ 备件录入** → 创建备件信息，关联设备
3. **✅ 关联建立** → 建立备件与设备的使用关系
4. **✅ 库存管理** → 入库、出库操作
5. **✅ 预警触发** → 系统自动检测并生成预警
6. **✅ 预警处理** → 人工处理预警记录

---

## 🚀 测试执行步骤

### 第1步：执行测试数据
```bash
# 在MySQL中执行上述所有SQL脚本
mysql -u root -plijing134 ruoyi-vue-pro < test_data.sql
```

### 第2步：重启服务
```bash
# 重启后端服务以加载新的Controller和定时任务
```

### 第3步：功能测试
1. **登录系统**，检查菜单是否正确显示
2. **设备档案管理**：查看设备列表，测试增删改查
3. **备件管理**：查看备件列表，确认扩展字段显示
4. **设备关联管理**：查看关联关系，测试新增关联
5. **预警记录管理**：查看预警列表（可能为空，需要触发定时任务）

### 第4步：预警功能测试
```sql
-- 手动触发预警检查（或等待定时任务执行）
-- 由于测试数据中SKF轴承6324库存为3，低于安全库存5，应该会生成预警
```

### 第5步：数据验证
```sql
-- 检查预警记录是否生成
SELECT * FROM coal_spare_part_alert ORDER BY create_time DESC;

-- 检查备件设备关联
SELECT * FROM coal_spare_part_equipment;

-- 检查备件信息
SELECT name, spare_part_type, safety_stock FROM erp_product WHERE spare_part_type IS NOT NULL;
```

---

## 📊 预期测试结果

### 正常情况下应该看到：
1. **设备档案**：2台破碎机设备
2. **备件信息**：3种备件（轴承×2，密封圈×1）
3. **设备关联**：3条关联记录
4. **库存记录**：3条库存记录
5. **预警记录**：2条库存不足预警（轴承库存低于安全库存）

### 如果功能正常：
- ✅ 所有页面都能正常访问
- ✅ 数据能正确显示（名称而非ID）
- ✅ 增删改查功能正常
- ✅ 预警能自动生成
- ✅ 预警能正常处理

---

**测试完成后，备件管理模块就完全可用了！** 🎉
