# 备件预警站内信模板创建指导

## 问题分析

根据你的错误信息，主要问题是：

1. **SQL错误**: `Table 'ruoyi-vue-pro.system_notify_template_type' doesn't exist`
   - 原因：芋道框架使用字典表 `system_dict_data` 来管理模板类型，而不是单独的表
   
2. **Java编译错误**: 
   - 方法名错误：`sendSingleNotifylToAdmin` 应该是 `sendSingleMessageToAdmin`
   - 日志工具错误：使用了错误的日志导入

## 解决方案

### 方案一：执行修正后的SQL脚本（推荐）

执行 `sql/mysql/create_spare_part_alert_notify_template_fixed.sql` 文件：

```sql
-- 1. 添加备件管理模板类型到字典表
INSERT IGNORE INTO `system_dict_data` (`id`, `sort`, `label`, `value`, `dict_type`, `status`, `color_type`, `css_class`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES
(2000, 3, '备件管理', '3', 'system_notify_template_type', 0, 'warning', '', '站内信模版的类型 - 备件管理', '1', NOW(), '1', NOW(), b'0');

-- 2. 创建备件预警通知模板
INSERT INTO `system_notify_template` (`id`, `name`, `code`, `nickname`, `content`, `type`, `params`, `status`, `remark`, `creator`, `create_time`, `updater`, `update_time`, `deleted`) VALUES
(1001, '备件预警通知', 'spare_part_alert', '系统管理员', 
'【备件预警通知】

预警标题：{alertTitle}
备件名称：{sparePartName}
预警类型：{alertType}
预警级别：{alertLevel}
预警信息：{alertMessage}
当前库存：{currentStock}
阈值：{thresholdValue}

请及时处理该预警信息！

发送时间：{sendTime}', 
3, 
'["alertTitle", "sparePartName", "alertType", "alertLevel", "alertMessage", "currentStock", "thresholdValue", "sendTime"]', 
0, 
'备件预警通知模板', 
'1', NOW(), '1', NOW(), b'0');
```

### 方案二：手动创建模板（如果SQL执行失败）

如果SQL脚本执行失败，可以通过前端界面手动创建：

#### 步骤1：创建模板类型（如果需要）

1. 进入 `系统管理 -> 字典管理`
2. 找到 `system_notify_template_type` 字典类型
3. 添加新的字典数据：
   - **字典标签**: `备件管理`
   - **字典键值**: `3`
   - **状态**: `正常`
   - **备注**: `站内信模版的类型 - 备件管理`

#### 步骤2：创建站内信模板

1. 进入 `系统管理 -> 消息中心 -> 站内信管理 -> 模板管理`
2. 点击 `新增` 按钮
3. 填写以下信息：

**基本信息：**
- **模版编号**: `spare_part_alert`
- **模版名称**: `备件预警通知`
- **发件人名称**: `系统管理员`

**模板内容：**
```
【备件预警通知】

预警标题：{alertTitle}
备件名称：{sparePartName}
预警类型：{alertType}
预警级别：{alertLevel}
预警信息：{alertMessage}
当前库存：{currentStock}
阈值：{thresholdValue}

请及时处理该预警信息！

发送时间：{sendTime}
```

**其他设置：**
- **模版类型**: 选择 `备件管理`（如果已创建）或 `系统消息`
- **开启状态**: `开启`
- **备注**: `备件预警通知模板`

4. 点击 `确定` 保存

## Java代码修复

我已经修复了 `SparePartAlertServiceImpl.java` 中的问题：

### 修复内容：

1. **方法名修正**：
   ```java
   // 错误的：
   notifyMessageSendApi.sendSingleNotifylToAdmin(...)
   
   // 正确的：
   notifyMessageSendApi.sendSingleMessageToAdmin(...)
   ```

2. **日志工具修正**：
   ```java
   // 移除错误的导入：
   // import static com.baomidou.mybatisplus.extension.ddl.DdlScriptErrorHandler.PrintlnLogErrorHandler.log;
   
   // 添加正确的导入：
   import org.slf4j.Logger;
   import org.slf4j.LoggerFactory;
   
   // 在类中添加：
   private static final Logger log = LoggerFactory.getLogger(SparePartAlertServiceImpl.class);
   ```

3. **模板参数完善**：
   ```java
   Map<String, Object> templateParams = new HashMap<>();
   templateParams.put("alertTitle", alert.getAlertTitle());
   templateParams.put("sparePartName", sparePartName);
   templateParams.put("alertType", getAlertTypeName(alert.getAlertType()));
   templateParams.put("alertLevel", getAlertLevelName(alert.getAlertLevel()));
   templateParams.put("alertMessage", alert.getAlertMessage());
   templateParams.put("currentStock", alert.getCurrentStock());
   templateParams.put("thresholdValue", alert.getThresholdValue());
   templateParams.put("sendTime", LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
   ```

## 测试验证

### 1. 编译测试
确保Java代码能正常编译，没有语法错误。

### 2. 模板测试
1. 在模板管理页面，找到刚创建的 `spare_part_alert` 模板
2. 点击 `测试` 按钮
3. 选择接收人为当前用户
4. 填写测试参数：
   ```json
   {
     "alertTitle": "测试预警",
     "sparePartName": "测试备件",
     "alertType": "库存不足",
     "alertLevel": "高",
     "alertMessage": "这是一个测试预警",
     "currentStock": "5",
     "thresholdValue": "10",
     "sendTime": "2024-01-01 12:00:00"
   }
   ```
5. 点击发送，检查是否收到站内信

### 3. 功能测试
1. 创建一个备件预警记录
2. 设置接收人
3. 点击 `发送` 按钮
4. 检查是否成功发送站内信

## 注意事项

1. **模板参数匹配**：确保模板内容中的 `{变量名}` 与代码中的 `templateParams` 的 key 完全一致
2. **字典数据**：如果手动创建模板类型，确保字典数据的 `value` 与模板的 `type` 字段匹配
3. **权限问题**：确保当前用户有发送站内信的权限
4. **租户隔离**：注意芋道框架的多租户特性，确保数据在正确的租户下

## 文件清单

### 修改的文件：
- `yudao-module-coal/src/main/java/cn/iocoder/yudao/module/coal/service/sparepartalert/SparePartAlertServiceImpl.java`

### 新增的文件：
- `sql/mysql/create_spare_part_alert_notify_template_fixed.sql`
- `learn/备件预警站内信模板创建指导.md`

现在你可以选择执行SQL脚本或手动创建模板，然后测试站内信发送功能了！
