# 备件管理模块完整业务逻辑

## 📊 系统架构设计

### 数据库表结构关系

```
核心业务流程：
设备档案(coal_equipment_info) 
    ↓ [1:N关联]
备件设备关联(coal_spare_part_equipment) ←→ ERP产品表(erp_product)[备件扩展]
    ↓ [库存监控]
ERP库存(erp_stock) → 备件预警记录(coal_spare_part_alert)
    ↓ [处理流程]
预警处理 → 采购申请 → 库存补充
```

### 模块依赖关系

```
基础模块(已完成):
- 设备档案管理 ✅
- ERP产品管理(备件扩展) ✅  
- ERP库存管理 ✅
- 用户权限管理 ✅

核心模块(待完善):
- 备件设备关联管理 🚧
- 备件预警记录管理 🚧

扩展模块(未来):
- 备件采购管理
- 备件使用记录
- 统计分析报表
```

## 🔄 完整业务流程

### 阶段一：基础数据录入

#### 1.1 设备档案管理 ✅
**操作路径**: 选煤厂管理 → 设备档案管理
```
业务场景: 录入所有生产设备信息
数据示例:
- 设备名称: 主破碎机
- 设备编号: PSJ-001
- 设备分类: 破碎设备
- 制造厂商: 山东某重工
- 安装位置: 破碎车间A区
- 责任人: 张工程师
```

#### 1.2 备件分类管理 ✅  
**操作路径**: ERP管理 → 产品管理 → 产品分类
```
业务场景: 建立备件分类体系
分类示例:
- 易损件
  - 轴承类
  - 密封件类
  - 滤芯类
- 标准件  
  - 螺栓类
  - 垫片类
- 电气件
  - 传感器类
  - 电缆类
```

#### 1.3 备件信息管理 ✅
**操作路径**: ERP管理 → 产品管理 → 备件管理
```
业务场景: 录入备件基础信息和扩展属性
数据示例:
基础信息:
- 备件名称: SKF轴承6324
- 备件编号: BJ-001-001
- 产品分类: 轴承类
- 单位: 个
- 规格: 120×260×55mm

备件扩展信息:
- 备件类型: 易损件
- 关联设备: 主破碎机(PSJ-001)
- 最小库存: 2个
- 最大库存: 10个
- 安全库存: 5个
- 供应商: SKF中国有限公司
- 更换周期: 180天
- 上次更换日期: 2024-06-01
- 下次更换日期: 2024-11-28
```

### 阶段二：关联关系建立

#### 2.1 备件设备关联管理 🚧
**操作路径**: 备件管理 → 设备关联管理
```
业务场景: 建立备件与设备的使用关系
关联示例:
- 备件: SKF轴承6324
- 关联设备: 主破碎机(PSJ-001)
- 是否必需: 是
- 标准用量: 4个
- 安装位置: 主轴承座
- 更换难度: 中等
- 备注: 每次更换需停机4小时
```

**业务规则**:
1. 一个备件可以关联多个设备
2. 一个设备可以使用多种备件
3. 必需备件库存不足时优先级更高
4. 关联信息影响预警策略

#### 2.2 库存管理 ✅
**操作路径**: ERP管理 → 库存管理
```
业务场景: 管理备件的入库、出库、盘点
操作示例:
入库:
- 备件: SKF轴承6324
- 入库数量: 8个
- 入库仓库: 备件库A区
- 供应商: SKF中国
- 采购单价: 1200元/个

出库:
- 领用设备: 主破碎机(PSJ-001)
- 出库数量: 4个
- 领用人: 李师傅
- 用途: 计划性维护
- 预计使用时间: 2024-12-01
```

### 阶段三：预警监控体系

#### 3.1 自动预警检测 🚧
**系统定时任务**:
```
每日8:00执行库存预警检测:
1. 检查所有备件当前库存
2. 对比安全库存阈值
3. 生成库存不足预警

每日8:00执行更换提醒检测:
1. 检查所有备件下次更换日期
2. 提前30天生成更换提醒
3. 根据备件重要程度设置提醒级别
```

#### 3.2 预警记录管理 🚧
**操作路径**: 备件管理 → 预警记录管理
```
预警类型:
1. 库存不足预警
   - 触发条件: 当前库存 < 安全库存
   - 预警级别: 根据备件重要程度(高/中/低)
   - 处理措施: 联系供应商补货

2. 到期更换预警  
   - 触发条件: 距离下次更换日期 < 30天
   - 预警级别: 根据设备重要程度
   - 处理措施: 安排维护计划

3. 超期未更换预警
   - 触发条件: 超过计划更换日期
   - 预警级别: 高
   - 处理措施: 紧急停机检查

预警处理流程:
待处理 → 处理中 → 已处理 → 已忽略
```

## 🎯 具体操作示例

### 示例场景：主破碎机轴承管理全流程

#### 第1步：录入设备档案
```
设备档案管理 → 新增
- 设备名称: 主破碎机
- 设备编号: PSJ-001
- 设备分类: 破碎设备
- 重要程度: 高
- 责任人: 张工程师
```

#### 第2步：创建备件信息
```
备件管理 → 新增产品
- 备件名称: SKF轴承6324
- 备件类型: 易损件
- 关联设备: 主破碎机
- 最小库存: 2个
- 安全库存: 5个
- 更换周期: 180天
- 供应商: SKF中国
```

#### 第3步：建立设备关联
```
设备关联管理 → 新增关联
- 备件: SKF轴承6324
- 设备: 主破碎机(PSJ-001)
- 是否必需: 是
- 用量: 4个/次
- 备注: 主轴承，停机更换
```

#### 第4步：库存入库
```
库存管理 → 入库单
- 备件: SKF轴承6324  
- 数量: 8个
- 仓库: 备件库A区
- 单价: 1200元
```

#### 第5步：系统自动监控
```
系统每日检测:
- 当前库存: 3个
- 安全库存: 5个
- 检测结果: 库存不足
→ 自动生成预警记录

预警信息:
- 预警类型: 库存不足
- 预警级别: 中等(易损件)
- 预警消息: "SKF轴承6324库存不足，当前3个，安全库存5个"
```

#### 第6步：预警处理
```
预警记录管理 → 处理预警
- 预警ID: ALT-001
- 处理人: 采购员小王
- 处理措施: 已联系SKF供应商，预计3天内到货8个
- 处理状态: 处理中 → 已处理
```

## 🔧 技术实现要点

### 前端API设计
```typescript
// 设备关联API
export const SparePartEquipmentApi = {
  getPage: (params) => request.get('/coal/spare-part-equipment/page', { params }),
  create: (data) => request.post('/coal/spare-part-equipment/create', data),
  update: (data) => request.put('/coal/spare-part-equipment/update', data),
  delete: (id) => request.delete(`/coal/spare-part-equipment/delete?id=${id}`),
  get: (id) => request.get(`/coal/spare-part-equipment/get?id=${id}`)
}

// 预警记录API  
export const SparePartAlertApi = {
  getPage: (params) => request.get('/coal/spare-part-alert/page', { params }),
  getPendingAlerts: () => request.get('/coal/spare-part-alert/pending'),
  handle: (id, handlerId, remark) => request.put('/coal/spare-part-alert/handle', { id, handlerId, remark }),
  ignore: (id, handlerId, remark) => request.put('/coal/spare-part-alert/ignore', { id, handlerId, remark }),
  delete: (id) => request.delete(`/coal/spare-part-alert/delete?id=${id}`)
}
```

### 后端定时任务
```java
@Scheduled(cron = "0 0 8 * * ?") // 每天8点执行
public void checkStockAlerts() {
    // 1. 查询所有备件当前库存
    // 2. 对比安全库存阈值  
    // 3. 生成库存不足预警
}

@Scheduled(cron = "0 0 8 * * ?") // 每天8点执行  
public void checkReplacementAlerts() {
    // 1. 查询所有备件更换计划
    // 2. 检查是否临近更换日期
    // 3. 生成更换提醒预警
}
```

## 📈 业务价值

### 管理效益
1. **库存优化**: 避免备件积压和缺货
2. **维护计划**: 提前安排设备维护
3. **成本控制**: 精确掌握备件使用情况
4. **风险预防**: 及时预警避免设备故障

### 操作效率  
1. **信息集中**: 所有备件信息统一管理
2. **自动监控**: 系统自动检测异常情况
3. **流程规范**: 标准化的预警处理流程
4. **数据追溯**: 完整的操作记录

## 🚀 后续扩展方向

### 短期优化
1. 移动端支持 - 现场快速查询备件信息
2. 二维码集成 - 扫码快速出入库
3. 报表统计 - 备件使用分析报告

### 长期规划
1. AI预测 - 基于历史数据预测备件需求
2. 供应链集成 - 与供应商系统对接
3. IoT集成 - 设备传感器数据自动触发预警
4. 成本分析 - 设备全生命周期成本分析

---

**文档版本**: v1.0  
**创建时间**: 2024-12-16  
**最后更新**: 2024-12-16  
**维护人员**: AI助手
