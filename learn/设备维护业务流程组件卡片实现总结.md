# 设备维护业务流程组件卡片实现总结

## 业务逻辑检查结果

经过详细检查，整个设备维护业务流程的实现情况如下：

### ✅ 已实现的业务逻辑

#### 1. 检修计划 → 检修单
- **实现位置**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceplan/index.vue`
- **功能**: 检修计划列表中的"生成检修单"按钮
- **触发条件**: 当检修计划审批状态为已通过（approvalStatus === 2）时显示
- **实现逻辑**: 
  - 用户确认后自动生成检修单
  - 自动填充设备信息、维护内容、安全措施等
  - 设置检修类型为计划性检修，优先级为中等

#### 2. 报修单 → 检修单
- **实现位置**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/repairrequest/index.vue`
- **功能**: 报修单列表中的"生成检修单"按钮
- **触发条件**: 当报修单状态为待处理（requestStatus === 1）时显示
- **实现逻辑**:
  - 用户确认后自动生成检修单
  - 根据故障级别确定检修级别
  - 设置检修类型为故障检修，优先级根据紧急程度确定

#### 3. 检修单 → 备件使用记录
- **实现位置**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceorder/index.vue`
- **功能**: 检修单列表中的"备件使用记录"按钮
- **实现逻辑**:
  - 跳转到备件使用记录页面
  - 传递检修单ID和设备ID作为查询参数
  - 自动过滤显示相关的备件使用记录

#### 4. 备件使用记录 → 备件库存更新
- **实现位置**: `yudao-module-coal/src/main/java/cn/iocoder/yudao/module/coal/service/sparepartinventorylog/SparePartInventoryLogServiceImpl.java`
- **功能**: 备件出入库记录自动更新库存
- **实现逻辑**:
  - 创建出入库记录时自动调用库存更新
  - 支持入库（正数）和出库（负数）操作
  - 自动检查并创建库存预警

### ❌ 缺失的业务逻辑

#### 备件使用记录 → 备件库存更新
- **问题**: 备件使用记录创建时没有自动创建出入库记录
- **影响**: 备件使用后库存不会自动减少
- **建议**: 需要在 `SparePartUsageRecordServiceImpl.createSparePartUsageRecord` 方法中添加自动创建出库记录的逻辑

## 业务流程组件卡片实现

### 组件特性

#### 1. 可视化流程图
- **设计**: 采用垂直流程图布局，清晰展示业务流程
- **节点类型**: 
  - 源节点（检修计划、报修单）：蓝色渐变
  - 中心节点（检修单、备件使用记录）：紫色渐变
  - 结束节点（库存更新）：绿色渐变
- **交互**: 点击节点可跳转到对应页面

#### 2. 实时数据统计
- **数据来源**: 并行调用各模块API获取统计数据
- **统计指标**:
  - 各模块记录数量
  - 待执行检修单数量
  - 今日备件使用数量
  - 低库存备件数量
  - 紧急任务数量

#### 3. 快速操作入口
- **功能**: 提供新建计划、新建报修、使用记录、库存查看等快速操作
- **设计**: 使用按钮组布局，便于快速访问

#### 4. 自动刷新机制
- **配置**: 支持自动刷新，默认5分钟间隔
- **生命周期**: 组件挂载时启动，卸载时清理定时器

### 技术实现

#### 1. 组件结构
```typescript
// 组件属性
interface Props {
  autoRefresh?: boolean // 是否自动刷新
  refreshInterval?: number // 刷新间隔(毫秒)
}

// 响应式数据
const loading = ref(false)
const businessFlowData = ref(null)
const refreshTimer = ref<NodeJS.Timeout | null>(null)
```

#### 2. 数据获取
```typescript
// 并行获取各模块统计数据
const [
  maintenancePlanResponse,
  repairRequestResponse,
  maintenanceOrderResponse,
  sparePartUsageResponse,
  sparePartStockResponse
] = await Promise.all([
  MaintenancePlanApi.getMaintenancePlanPage({ pageNo: 1, pageSize: 1 }),
  RepairRequestApi.getRepairRequestPage({ pageNo: 1, pageSize: 1 }),
  MaintenanceOrderApi.getMaintenanceOrderPage({ pageNo: 1, pageSize: 1 }),
  SparePartUsageRecordApi.getSparePartUsageRecordPage({ pageNo: 1, pageSize: 1 }),
  SparePartStockApi.getSparePartStockPage({ pageNo: 1, pageSize: 1 })
])
```

#### 3. 样式设计
- **响应式布局**: 支持移动端适配
- **渐变背景**: 使用CSS渐变增强视觉效果
- **悬停效果**: 添加阴影和位移动画
- **颜色系统**: 统一的颜色主题，便于识别不同节点类型

### 集成到首页

#### 1. 组件导入
```typescript
import EquipmentMaintenanceBusinessFlowCard from '@/components/EquipmentMaintenanceBusinessFlowCard.vue'
```

#### 2. 组件使用
```html
<!-- 设备维护业务流程卡片 -->
<EquipmentMaintenanceBusinessFlowCard :auto-refresh="true" />
```

#### 3. 布局位置
- 放置在备件预警待处理卡片之后
- 与其他备件相关卡片保持一致的布局风格

## 业务流程完整性

### 当前状态
```
检修计划 ──┐
           ├──→ 检修单 ──→ 备件使用记录 ──→ ❌ 库存更新（缺失）
报修单 ────┘
```

### 建议完善
1. **实现备件使用记录自动创建出库记录**
2. **添加业务流程状态跟踪**
3. **实现业务流程异常处理机制**

## 使用说明

### 1. 查看业务流程
- 访问首页即可看到业务流程卡片
- 卡片显示各模块的实时统计数据
- 点击节点可跳转到对应功能页面

### 2. 快速操作
- 使用卡片底部的快速操作按钮
- 支持新建计划、报修、查看记录等操作

### 3. 数据刷新
- 卡片支持自动刷新（5分钟间隔）
- 可手动点击刷新按钮更新数据

## 技术规范

### 1. 遵循芋道框架规范
- 使用Element Plus组件库
- 遵循Vue 3 Composition API规范
- 使用TypeScript类型定义
- 遵循项目目录结构

### 2. 性能优化
- 使用并行API调用减少加载时间
- 实现自动刷新机制减少手动操作
- 使用骨架屏提升用户体验

### 3. 可维护性
- 组件化设计，便于复用
- 清晰的代码结构和注释
- 统一的错误处理机制

## 相关文件

- `yudao-ui/yudao-ui-admin-vue3/src/components/EquipmentMaintenanceBusinessFlowCard.vue` - 业务流程组件
- `yudao-ui/yudao-ui-admin-vue3/src/views/Home/Index.vue` - 首页集成
- `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceplan/index.vue` - 检修计划页面
- `yudao-ui/yudao-ui-admin-vue3/src/views/coal/repairrequest/index.vue` - 报修单页面
- `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceorder/index.vue` - 检修单页面
- `yudao-ui/yudao-ui-admin-vue3/src/views/coal/sparepartusagerecord/index.vue` - 备件使用记录页面
