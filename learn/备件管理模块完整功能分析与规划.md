# å¤‡ä»¶ç®¡ç†æ¨¡å—å®Œæ•´åŠŸèƒ½åˆ†æä¸è§„åˆ’

## ğŸ“Š å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

#### 1. åŸºç¡€æ•°æ®ç®¡ç†
- **å¤‡ä»¶åˆ†ç±»ç®¡ç†** (`sparepartcategory`) - æ ‘è¡¨ç»“æ„ âœ…
- **å¤‡ä»¶åŸºç¡€ä¿¡æ¯ç®¡ç†** (`sparepartinfo`) - å•è¡¨CRUD âœ…
  - åŒ…å«å›¾ç‰‡ä¸Šä¼ ã€è¯´æ˜ä¹¦ä¸Šä¼ ã€å›¾çº¸æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ âœ…
- **å¤‡ä»¶è®¾å¤‡å…³è”ç®¡ç†** (`sparepartequipment`) - ä¸»å­è¡¨ç»“æ„ âœ…

#### 2. åº“å­˜ç®¡ç†
- **å¤‡ä»¶åº“å­˜è®°å½•ç®¡ç†** (`sparepartstock`) - å•è¡¨CRUD âœ…
- **å¤‡ä»¶å‡ºå…¥åº“è®°å½•ç®¡ç†** (`sparepartinventorylog`) - å•è¡¨CRUD âœ…

#### 3. ä½¿ç”¨ç®¡ç†
- **å¤‡ä»¶ä½¿ç”¨è®°å½•ç®¡ç†** (`sparepartusagerecord`) - å•è¡¨CRUD âœ…
- **å¤‡ä»¶é¢„è­¦è®°å½•ç®¡ç†** (`sparepartalert`) - å•è¡¨CRUD âœ…

#### 4. æŠ€æœ¯å®ç°
- å­—å…¸æ•°æ®é…ç½®å®Œæ•´ âœ…
- æ—¶é—´æ ¼å¼æ ‡å‡†åŒ– âœ…
- ç”¨æˆ·é€‰æ‹©ç»„ä»¶é›†æˆ âœ…
- æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½é›†æˆ âœ…
- èœå•æƒé™é…ç½® âœ…

### âŒ ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½

#### 1. ä¸šåŠ¡é€»è¾‘é›†æˆ
- **åº“å­˜è‡ªåŠ¨æ›´æ–°æœºåˆ¶** - å‡ºå…¥åº“åè‡ªåŠ¨æ›´æ–°åº“å­˜æ•°é‡
- **é¢„è­¦è‡ªåŠ¨è§¦å‘æœºåˆ¶** - åº“å­˜ä½äºé˜ˆå€¼æ—¶è‡ªåŠ¨åˆ›å»ºé¢„è­¦
- **ä½¿ç”¨è®°å½•ä¸åº“å­˜è”åŠ¨** - ä½¿ç”¨å¤‡ä»¶æ—¶è‡ªåŠ¨æ‰£å‡åº“å­˜

#### 2. ç»Ÿè®¡åˆ†æåŠŸèƒ½
- **åº“å­˜ç»Ÿè®¡åˆ†æ** - åº“å­˜æ•°é‡ã€æˆæœ¬åˆ†æ
- **ä½¿ç”¨é¢‘ç‡åˆ†æ** - å¤‡ä»¶ä½¿ç”¨æƒ…å†µç»Ÿè®¡
- **å¯¿å‘½é¢„æµ‹åˆ†æ** - åŸºäºä½¿ç”¨è®°å½•çš„å¯¿å‘½é¢„æµ‹
- **æˆæœ¬æ ¸ç®—åˆ†æ** - å¤‡ä»¶é‡‡è´­å’Œä½¿ç”¨æˆæœ¬ç»Ÿè®¡

#### 3. é¢„è­¦æ¨é€åŠŸèƒ½
- **æ¶ˆæ¯æ¨é€æœºåˆ¶** - é¢„è­¦æ—¶è‡ªåŠ¨å‘é€é€šçŸ¥
- **é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥** - å¤šæ¸ é“é¢„è­¦é€šçŸ¥
- **é¢„è­¦è§„åˆ™é…ç½®** - å¯é…ç½®çš„é¢„è­¦é˜ˆå€¼å’Œè§„åˆ™

#### 4. æŠ¥è¡¨åŠŸèƒ½
- **åº“å­˜æŠ¥è¡¨** - å½“å‰åº“å­˜ã€å®‰å…¨åº“å­˜æŠ¥è¡¨
- **å‡ºå…¥åº“æŠ¥è¡¨** - å‡ºå…¥åº“æµæ°´æŠ¥è¡¨
- **ä½¿ç”¨è®°å½•æŠ¥è¡¨** - å¤‡ä»¶ä½¿ç”¨æƒ…å†µæŠ¥è¡¨
- **é¢„è­¦æŠ¥è¡¨** - é¢„è­¦è®°å½•ç»Ÿè®¡æŠ¥è¡¨

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘å®Œå–„ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 1.1 åº“å­˜è‡ªåŠ¨æ›´æ–°æœºåˆ¶
**ç›®æ ‡ï¼š** å®ç°å‡ºå…¥åº“æ“ä½œåè‡ªåŠ¨æ›´æ–°åº“å­˜æ•°é‡

**å®ç°æ–¹æ¡ˆï¼š**
```java
// åœ¨å‡ºå…¥åº“è®°å½•ä¿å­˜åï¼Œè‡ªåŠ¨æ›´æ–°åº“å­˜
@Service
public class SparePartInventoryLogServiceImpl {
    
    @Transactional
    public Long createSparePartInventoryLog(SparePartInventoryLogCreateReqVO createReqVO) {
        // 1. ä¿å­˜å‡ºå…¥åº“è®°å½•
        SparePartInventoryLogDO log = BeanUtils.toBean(createReqVO, SparePartInventoryLogDO.class);
        sparePartInventoryLogMapper.insert(log);
        
        // 2. è‡ªåŠ¨æ›´æ–°åº“å­˜
        updateStockQuantity(log);
        
        // 3. æ£€æŸ¥é¢„è­¦
        checkAndCreateAlert(log.getSparePartId());
        
        return log.getId();
    }
    
    private void updateStockQuantity(SparePartInventoryLogDO log) {
        // æ ¹æ®æ“ä½œç±»å‹æ›´æ–°åº“å­˜
        if (log.getOperationType() == 1) { // å…¥åº“
            sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity());
        } else { // å‡ºåº“
            sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity());
        }
    }
}
```

#### 1.2 é¢„è­¦è‡ªåŠ¨è§¦å‘æœºåˆ¶
**ç›®æ ‡ï¼š** åº“å­˜å˜åŒ–æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºé¢„è­¦

**å®ç°æ–¹æ¡ˆï¼š**
```java
@Service
public class SparePartAlertServiceImpl {
    
    public void checkAndCreateAlert(Long sparePartId) {
        // 1. è·å–å¤‡ä»¶åŸºç¡€ä¿¡æ¯
        SparePartInfoDO sparePart = sparePartInfoService.getSparePartInfo(sparePartId);
        
        // 2. è·å–å½“å‰åº“å­˜
        SparePartStockDO stock = sparePartStockService.getCurrentStock(sparePartId);
        
        // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„è­¦
        if (stock.getCurrentStock() <= sparePart.getMinStock()) {
            createLowStockAlert(sparePart, stock);
        }
        
        // 4. æ£€æŸ¥è¿‡æœŸé¢„è­¦
        checkExpirationAlert(sparePart, stock);
    }
    
    private void createLowStockAlert(SparePartInfoDO sparePart, SparePartStockDO stock) {
        SparePartAlertCreateReqVO alert = new SparePartAlertCreateReqVO();
        alert.setSparePartId(sparePart.getId());
        alert.setAlertType(1); // åº“å­˜ä¸è¶³
        alert.setAlertLevel(calculateAlertLevel(stock.getCurrentStock(), sparePart.getMinStock()));
        alert.setMessage(String.format("å¤‡ä»¶ %s åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š%dï¼Œæœ€ä½åº“å­˜ï¼š%d", 
            sparePart.getSparePartName(), stock.getCurrentStock(), sparePart.getMinStock()));
        createSparePartAlert(alert);
    }
}
```

#### 1.3 ä½¿ç”¨è®°å½•ä¸åº“å­˜è”åŠ¨
**ç›®æ ‡ï¼š** è®°å½•å¤‡ä»¶ä½¿ç”¨æ—¶è‡ªåŠ¨æ‰£å‡åº“å­˜

**å®ç°æ–¹æ¡ˆï¼š**
```java
@Service
public class SparePartUsageRecordServiceImpl {
    
    @Transactional
    public Long createSparePartUsageRecord(SparePartUsageRecordCreateReqVO createReqVO) {
        // 1. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        validateStock(createReqVO.getSparePartId(), createReqVO.getUsageCount());
        
        // 2. ä¿å­˜ä½¿ç”¨è®°å½•
        SparePartUsageRecordDO record = BeanUtils.toBean(createReqVO, SparePartUsageRecordDO.class);
        sparePartUsageRecordMapper.insert(record);
        
        // 3. è‡ªåŠ¨æ‰£å‡åº“å­˜
        sparePartStockService.decreaseStock(createReqVO.getSparePartId(), createReqVO.getUsageCount());
        
        // 4. åˆ›å»ºå‡ºåº“è®°å½•
        createInventoryLog(createReqVO);
        
        // 5. æ£€æŸ¥é¢„è­¦
        checkAndCreateAlert(createReqVO.getSparePartId());
        
        return record.getId();
    }
}
```

### ç¬¬äºŒé˜¶æ®µï¼šç»Ÿè®¡åˆ†æåŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 2.1 åº“å­˜ç»Ÿè®¡åˆ†æ
**åŠŸèƒ½ï¼š** æä¾›åº“å­˜æ•°é‡ã€æˆæœ¬ã€å‘¨è½¬ç‡ç­‰ç»Ÿè®¡

**å®ç°æ–¹æ¡ˆï¼š**
```java
@RestController
@RequestMapping("/coal/spare-part-statistics")
public class SparePartStatisticsController {
    
    @GetMapping("/stock-summary")
    public CommonResult<StockSummaryVO> getStockSummary() {
        // åº“å­˜æ€»è§ˆç»Ÿè®¡
        return success(sparePartStatisticsService.getStockSummary());
    }
    
    @GetMapping("/stock-cost-analysis")
    public CommonResult<List<StockCostAnalysisVO>> getStockCostAnalysis() {
        // åº“å­˜æˆæœ¬åˆ†æ
        return success(sparePartStatisticsService.getStockCostAnalysis());
    }
    
    @GetMapping("/stock-turnover")
    public CommonResult<List<StockTurnoverVO>> getStockTurnover() {
        // åº“å­˜å‘¨è½¬ç‡åˆ†æ
        return success(sparePartStatisticsService.getStockTurnover());
    }
}
```

#### 2.2 ä½¿ç”¨é¢‘ç‡åˆ†æ
**åŠŸèƒ½ï¼š** åˆ†æå¤‡ä»¶ä½¿ç”¨é¢‘ç‡ï¼Œä¸ºé‡‡è´­è®¡åˆ’æä¾›ä¾æ®

**å®ç°æ–¹æ¡ˆï¼š**
```java
@Service
public class SparePartStatisticsServiceImpl {
    
    public List<UsageFrequencyAnalysisVO> getUsageFrequencyAnalysis() {
        // 1. ç»Ÿè®¡å„å¤‡ä»¶çš„ä½¿ç”¨æ¬¡æ•°
        // 2. è®¡ç®—ä½¿ç”¨é¢‘ç‡
        // 3. æŒ‰é¢‘ç‡æ’åº
        // 4. æä¾›é‡‡è´­å»ºè®®
    }
    
    public List<LifespanAnalysisVO> getLifespanAnalysis() {
        // 1. åŸºäºä½¿ç”¨è®°å½•è®¡ç®—å¹³å‡å¯¿å‘½
        // 2. é¢„æµ‹ä¸‹æ¬¡æ›´æ¢æ—¶é—´
        // 3. æä¾›ç»´æŠ¤è®¡åˆ’å»ºè®®
    }
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šé¢„è­¦æ¨é€åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 3.1 æ¶ˆæ¯æ¨é€æœºåˆ¶
**åŠŸèƒ½ï¼š** å®ç°å¤šæ¸ é“é¢„è­¦é€šçŸ¥

**å®ç°æ–¹æ¡ˆï¼š**
```java
@Service
public class SparePartAlertNotificationService {
    
    @EventListener
    public void handleLowStockAlert(LowStockAlertEvent event) {
        // 1. å‘é€ç³»ç»Ÿæ¶ˆæ¯
        sendSystemMessage(event);
        
        // 2. å‘é€é‚®ä»¶é€šçŸ¥
        sendEmailNotification(event);
        
        // 3. å‘é€çŸ­ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        sendSmsNotification(event);
        
        // 4. å‘é€é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        sendWorkNotification(event);
    }
}
```

#### 3.2 é¢„è­¦è§„åˆ™é…ç½®
**åŠŸèƒ½ï¼š** æ”¯æŒå¯é…ç½®çš„é¢„è­¦è§„åˆ™

**å®ç°æ–¹æ¡ˆï¼š**
```java
@Entity
@Table(name = "coal_spare_part_alert_rule")
public class SparePartAlertRuleDO {
    private Long id;
    private Long sparePartId; // å¤‡ä»¶IDï¼Œnullè¡¨ç¤ºå…¨å±€è§„åˆ™
    private Integer alertType; // é¢„è­¦ç±»å‹ï¼š1-åº“å­˜ä¸è¶³ï¼Œ2-å³å°†è¿‡æœŸ
    private Integer threshold; // é¢„è­¦é˜ˆå€¼
    private Integer alertLevel; // é¢„è­¦çº§åˆ«
    private String notificationChannels; // é€šçŸ¥æ¸ é“ï¼šemail,sms,system
    private Boolean enabled; // æ˜¯å¦å¯ç”¨
}
```

### ç¬¬å››é˜¶æ®µï¼šæŠ¥è¡¨åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### 4.1 åº“å­˜æŠ¥è¡¨
**åŠŸèƒ½ï¼š** ç”Ÿæˆå„ç§åº“å­˜ç›¸å…³æŠ¥è¡¨

**å®ç°æ–¹æ¡ˆï¼š**
```java
@RestController
@RequestMapping("/coal/spare-part-reports")
public class SparePartReportController {
    
    @GetMapping("/stock-report")
    public void exportStockReport(HttpServletResponse response) {
        // å¯¼å‡ºåº“å­˜æŠ¥è¡¨
        sparePartReportService.exportStockReport(response);
    }
    
    @GetMapping("/inventory-report")
    public void exportInventoryReport(HttpServletResponse response) {
        // å¯¼å‡ºå‡ºå…¥åº“æŠ¥è¡¨
        sparePartReportService.exportInventoryReport(response);
    }
}
```

## ğŸ›  æŠ€æœ¯å®ç°è¦ç‚¹

### 1. äº‹åŠ¡ç®¡ç†
- ä½¿ç”¨ `@Transactional` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- åº“å­˜æ›´æ–°ã€ä½¿ç”¨è®°å½•ã€å‡ºå…¥åº“è®°å½•åœ¨åŒä¸€äº‹åŠ¡ä¸­

### 2. å¼‚æ­¥å¤„ç†
- é¢„è­¦æ£€æŸ¥ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
- æ¶ˆæ¯æ¨é€ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†

### 3. ç¼“å­˜ä¼˜åŒ–
- åº“å­˜æ•°æ®ä½¿ç”¨Redisç¼“å­˜
- é¢„è­¦è§„åˆ™é…ç½®ç¼“å­˜

### 4. å®šæ—¶ä»»åŠ¡
- å®šæœŸæ£€æŸ¥é¢„è­¦çŠ¶æ€
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- å®šæœŸç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨

## ğŸ“‹ å¼€å‘ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¼€å‘ï¼‰
1. âœ… åº“å­˜è‡ªåŠ¨æ›´æ–°æœºåˆ¶
2. âœ… é¢„è­¦è‡ªåŠ¨è§¦å‘æœºåˆ¶  
3. âœ… ä½¿ç”¨è®°å½•ä¸åº“å­˜è”åŠ¨

### ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå¼€å‘ï¼‰
1. ğŸ“Š åº“å­˜ç»Ÿè®¡åˆ†æåŠŸèƒ½
2. ğŸ“Š ä½¿ç”¨é¢‘ç‡åˆ†æåŠŸèƒ½
3. ğŸ”” æ¶ˆæ¯æ¨é€æœºåˆ¶
4. âš™ï¸ é¢„è­¦è§„åˆ™é…ç½®

### ä½ä¼˜å…ˆçº§ï¼ˆåæœŸå¼€å‘ï¼‰
1. ğŸ“ˆ æŠ¥è¡¨åŠŸèƒ½
2. ğŸ“± ç§»åŠ¨ç«¯æ”¯æŒ
3. ğŸ”— ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ

## ğŸ¯ é¢„æœŸæ•ˆæœ

å®Œæˆè¿™äº›åŠŸèƒ½åï¼Œå¤‡ä»¶ç®¡ç†æ¨¡å—å°†å®ç°ï¼š

1. **è‡ªåŠ¨åŒ–ç®¡ç†** - åº“å­˜è‡ªåŠ¨æ›´æ–°ï¼Œé¢„è­¦è‡ªåŠ¨è§¦å‘
2. **æ™ºèƒ½åŒ–åˆ†æ** - ä½¿ç”¨é¢‘ç‡åˆ†æï¼Œå¯¿å‘½é¢„æµ‹
3. **å¯è§†åŒ–æŠ¥è¡¨** - å¤šç»´åº¦ç»Ÿè®¡åˆ†æ
4. **å¤šæ¸ é“é€šçŸ¥** - åŠæ—¶é¢„è­¦é€šçŸ¥
5. **å¯é…ç½®è§„åˆ™** - çµæ´»çš„é¢„è­¦å’Œç®¡ç†è§„åˆ™

è¿™å°†å¤§å¤§æå‡å¤‡ä»¶ç®¡ç†çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼Œä¸ºè®¾å¤‡ç»´æŠ¤æä¾›æœ‰åŠ›æ”¯æ’‘ã€‚
