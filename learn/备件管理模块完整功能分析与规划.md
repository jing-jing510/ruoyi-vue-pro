# 备件管理模块完整功能分析与规划

## 📊 当前实现状态

### ✅ 已完成的功能

#### 1. 基础数据管理
- **备件分类管理** (`sparepartcategory`) - 树表结构 ✅
- **备件基础信息管理** (`sparepartinfo`) - 单表CRUD ✅
  - 包含图片上传、说明书上传、图纸文件上传功能 ✅
- **备件设备关联管理** (`sparepartequipment`) - 主子表结构 ✅

#### 2. 库存管理
- **备件库存记录管理** (`sparepartstock`) - 单表CRUD ✅
- **备件出入库记录管理** (`sparepartinventorylog`) - 单表CRUD ✅

#### 3. 使用管理
- **备件使用记录管理** (`sparepartusagerecord`) - 单表CRUD ✅
- **备件预警记录管理** (`sparepartalert`) - 单表CRUD ✅

#### 4. 技术实现
- 字典数据配置完整 ✅
- 时间格式标准化 ✅
- 用户选择组件集成 ✅
- 文件上传功能集成 ✅
- 菜单权限配置 ✅

### ❌ 缺失的核心功能

#### 1. 业务逻辑集成
- **库存自动更新机制** - 出入库后自动更新库存数量
- **预警自动触发机制** - 库存低于阈值时自动创建预警
- **使用记录与库存联动** - 使用备件时自动扣减库存

#### 2. 统计分析功能
- **库存统计分析** - 库存数量、成本分析
- **使用频率分析** - 备件使用情况统计
- **寿命预测分析** - 基于使用记录的寿命预测
- **成本核算分析** - 备件采购和使用成本统计

#### 3. 预警推送功能
- **消息推送机制** - 预警时自动发送通知
- **邮件/短信通知** - 多渠道预警通知
- **预警规则配置** - 可配置的预警阈值和规则

#### 4. 报表功能
- **库存报表** - 当前库存、安全库存报表
- **出入库报表** - 出入库流水报表
- **使用记录报表** - 备件使用情况报表
- **预警报表** - 预警记录统计报表

## 🎯 下一步开发计划

### 第一阶段：业务逻辑完善（优先级：高）

#### 1.1 库存自动更新机制
**目标：** 实现出入库操作后自动更新库存数量

**实现方案：**
```java
// 在出入库记录保存后，自动更新库存
@Service
public class SparePartInventoryLogServiceImpl {
    
    @Transactional
    public Long createSparePartInventoryLog(SparePartInventoryLogCreateReqVO createReqVO) {
        // 1. 保存出入库记录
        SparePartInventoryLogDO log = BeanUtils.toBean(createReqVO, SparePartInventoryLogDO.class);
        sparePartInventoryLogMapper.insert(log);
        
        // 2. 自动更新库存
        updateStockQuantity(log);
        
        // 3. 检查预警
        checkAndCreateAlert(log.getSparePartId());
        
        return log.getId();
    }
    
    private void updateStockQuantity(SparePartInventoryLogDO log) {
        // 根据操作类型更新库存
        if (log.getOperationType() == 1) { // 入库
            sparePartStockService.increaseStock(log.getSparePartId(), log.getQuantity());
        } else { // 出库
            sparePartStockService.decreaseStock(log.getSparePartId(), log.getQuantity());
        }
    }
}
```

#### 1.2 预警自动触发机制
**目标：** 库存变化时自动检查并创建预警

**实现方案：**
```java
@Service
public class SparePartAlertServiceImpl {
    
    public void checkAndCreateAlert(Long sparePartId) {
        // 1. 获取备件基础信息
        SparePartInfoDO sparePart = sparePartInfoService.getSparePartInfo(sparePartId);
        
        // 2. 获取当前库存
        SparePartStockDO stock = sparePartStockService.getCurrentStock(sparePartId);
        
        // 3. 检查是否需要预警
        if (stock.getCurrentStock() <= sparePart.getMinStock()) {
            createLowStockAlert(sparePart, stock);
        }
        
        // 4. 检查过期预警
        checkExpirationAlert(sparePart, stock);
    }
    
    private void createLowStockAlert(SparePartInfoDO sparePart, SparePartStockDO stock) {
        SparePartAlertCreateReqVO alert = new SparePartAlertCreateReqVO();
        alert.setSparePartId(sparePart.getId());
        alert.setAlertType(1); // 库存不足
        alert.setAlertLevel(calculateAlertLevel(stock.getCurrentStock(), sparePart.getMinStock()));
        alert.setMessage(String.format("备件 %s 库存不足，当前库存：%d，最低库存：%d", 
            sparePart.getSparePartName(), stock.getCurrentStock(), sparePart.getMinStock()));
        createSparePartAlert(alert);
    }
}
```

#### 1.3 使用记录与库存联动
**目标：** 记录备件使用时自动扣减库存

**实现方案：**
```java
@Service
public class SparePartUsageRecordServiceImpl {
    
    @Transactional
    public Long createSparePartUsageRecord(SparePartUsageRecordCreateReqVO createReqVO) {
        // 1. 检查库存是否充足
        validateStock(createReqVO.getSparePartId(), createReqVO.getUsageCount());
        
        // 2. 保存使用记录
        SparePartUsageRecordDO record = BeanUtils.toBean(createReqVO, SparePartUsageRecordDO.class);
        sparePartUsageRecordMapper.insert(record);
        
        // 3. 自动扣减库存
        sparePartStockService.decreaseStock(createReqVO.getSparePartId(), createReqVO.getUsageCount());
        
        // 4. 创建出库记录
        createInventoryLog(createReqVO);
        
        // 5. 检查预警
        checkAndCreateAlert(createReqVO.getSparePartId());
        
        return record.getId();
    }
}
```

### 第二阶段：统计分析功能（优先级：中）

#### 2.1 库存统计分析
**功能：** 提供库存数量、成本、周转率等统计

**实现方案：**
```java
@RestController
@RequestMapping("/coal/spare-part-statistics")
public class SparePartStatisticsController {
    
    @GetMapping("/stock-summary")
    public CommonResult<StockSummaryVO> getStockSummary() {
        // 库存总览统计
        return success(sparePartStatisticsService.getStockSummary());
    }
    
    @GetMapping("/stock-cost-analysis")
    public CommonResult<List<StockCostAnalysisVO>> getStockCostAnalysis() {
        // 库存成本分析
        return success(sparePartStatisticsService.getStockCostAnalysis());
    }
    
    @GetMapping("/stock-turnover")
    public CommonResult<List<StockTurnoverVO>> getStockTurnover() {
        // 库存周转率分析
        return success(sparePartStatisticsService.getStockTurnover());
    }
}
```

#### 2.2 使用频率分析
**功能：** 分析备件使用频率，为采购计划提供依据

**实现方案：**
```java
@Service
public class SparePartStatisticsServiceImpl {
    
    public List<UsageFrequencyAnalysisVO> getUsageFrequencyAnalysis() {
        // 1. 统计各备件的使用次数
        // 2. 计算使用频率
        // 3. 按频率排序
        // 4. 提供采购建议
    }
    
    public List<LifespanAnalysisVO> getLifespanAnalysis() {
        // 1. 基于使用记录计算平均寿命
        // 2. 预测下次更换时间
        // 3. 提供维护计划建议
    }
}
```

### 第三阶段：预警推送功能（优先级：中）

#### 3.1 消息推送机制
**功能：** 实现多渠道预警通知

**实现方案：**
```java
@Service
public class SparePartAlertNotificationService {
    
    @EventListener
    public void handleLowStockAlert(LowStockAlertEvent event) {
        // 1. 发送系统消息
        sendSystemMessage(event);
        
        // 2. 发送邮件通知
        sendEmailNotification(event);
        
        // 3. 发送短信通知（可选）
        sendSmsNotification(event);
        
        // 4. 发送钉钉/企业微信通知（可选）
        sendWorkNotification(event);
    }
}
```

#### 3.2 预警规则配置
**功能：** 支持可配置的预警规则

**实现方案：**
```java
@Entity
@Table(name = "coal_spare_part_alert_rule")
public class SparePartAlertRuleDO {
    private Long id;
    private Long sparePartId; // 备件ID，null表示全局规则
    private Integer alertType; // 预警类型：1-库存不足，2-即将过期
    private Integer threshold; // 预警阈值
    private Integer alertLevel; // 预警级别
    private String notificationChannels; // 通知渠道：email,sms,system
    private Boolean enabled; // 是否启用
}
```

### 第四阶段：报表功能（优先级：低）

#### 4.1 库存报表
**功能：** 生成各种库存相关报表

**实现方案：**
```java
@RestController
@RequestMapping("/coal/spare-part-reports")
public class SparePartReportController {
    
    @GetMapping("/stock-report")
    public void exportStockReport(HttpServletResponse response) {
        // 导出库存报表
        sparePartReportService.exportStockReport(response);
    }
    
    @GetMapping("/inventory-report")
    public void exportInventoryReport(HttpServletResponse response) {
        // 导出出入库报表
        sparePartReportService.exportInventoryReport(response);
    }
}
```

## 🛠 技术实现要点

### 1. 事务管理
- 使用 `@Transactional` 确保数据一致性
- 库存更新、使用记录、出入库记录在同一事务中

### 2. 异步处理
- 预警检查使用异步处理，避免阻塞主流程
- 消息推送使用消息队列异步处理

### 3. 缓存优化
- 库存数据使用Redis缓存
- 预警规则配置缓存

### 4. 定时任务
- 定期检查预警状态
- 定期清理过期数据
- 定期生成统计报表

## 📋 开发优先级

### 高优先级（立即开发）
1. ✅ 库存自动更新机制
2. ✅ 预警自动触发机制  
3. ✅ 使用记录与库存联动

### 中优先级（近期开发）
1. 📊 库存统计分析功能
2. 📊 使用频率分析功能
3. 🔔 消息推送机制
4. ⚙️ 预警规则配置

### 低优先级（后期开发）
1. 📈 报表功能
2. 📱 移动端支持
3. 🔗 第三方系统集成

## 🎯 预期效果

完成这些功能后，备件管理模块将实现：

1. **自动化管理** - 库存自动更新，预警自动触发
2. **智能化分析** - 使用频率分析，寿命预测
3. **可视化报表** - 多维度统计分析
4. **多渠道通知** - 及时预警通知
5. **可配置规则** - 灵活的预警和管理规则

这将大大提升备件管理的效率和准确性，为设备维护提供有力支撑。
