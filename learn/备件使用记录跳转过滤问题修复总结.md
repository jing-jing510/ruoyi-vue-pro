# 备件使用记录跳转过滤问题修复总结

## 问题描述

从检修单页面点击"备件使用记录"按钮跳转到备件使用记录页面时，URL参数正确传递了（如：`workOrderId=13&equipmentId=3`），但页面没有根据这些参数过滤显示对应的记录。

## 问题原因

**后端Mapper查询条件缺失**: 在 `SparePartUsageRecordMapper.java` 的 `selectPage` 方法中，没有包含 `workOrderId` 和 `equipmentId` 的查询条件，导致即使前端传递了这些参数，后端也不会根据这些条件进行过滤。

## 修复内容

### 1. 修正 SparePartUsageRecordMapper.java

**修复前**:
```java
default PageResult<SparePartUsageRecordDO> selectPage(SparePartUsageRecordPageReqVO reqVO) {
    return selectPage(reqVO, new LambdaQueryWrapperX<SparePartUsageRecordDO>()
            .eqIfPresent(SparePartUsageRecordDO::getUsageType, reqVO.getUsageType())
            .betweenIfPresent(SparePartUsageRecordDO::getUsageDate, reqVO.getUsageDate())
            .eqIfPresent(SparePartUsageRecordDO::getPerformanceRating, reqVO.getPerformanceRating())
            .betweenIfPresent(SparePartUsageRecordDO::getCreateTime, reqVO.getCreateTime())
            .orderByDesc(SparePartUsageRecordDO::getId));
}
```

**修复后**:
```java
default PageResult<SparePartUsageRecordDO> selectPage(SparePartUsageRecordPageReqVO reqVO) {
    return selectPage(reqVO, new LambdaQueryWrapperX<SparePartUsageRecordDO>()
            .eqIfPresent(SparePartUsageRecordDO::getUsageType, reqVO.getUsageType())
            .betweenIfPresent(SparePartUsageRecordDO::getUsageDate, reqVO.getUsageDate())
            .eqIfPresent(SparePartUsageRecordDO::getPerformanceRating, reqVO.getPerformanceRating())
            .eqIfPresent(SparePartUsageRecordDO::getWorkOrderId, reqVO.getWorkOrderId())      // 新增
            .eqIfPresent(SparePartUsageRecordDO::getEquipmentId, reqVO.getEquipmentId())      // 新增
            .betweenIfPresent(SparePartUsageRecordDO::getCreateTime, reqVO.getCreateTime())
            .orderByDesc(SparePartUsageRecordDO::getId));
}
```

### 2. 设备API调用错误修复

**问题**: 使用了不存在的 `getEquipmentInfoPage` 方法
**修复**: 改为使用正确的 `getEquipmentInfoList` 方法

**修复前**:
```typescript
const data = await EquipmentInfoApi.getEquipmentInfoPage({ pageNo: 1, pageSize: 100 })
equipmentList.value = data.list || []
```

**修复后**:
```typescript
const data = await EquipmentInfoApi.getEquipmentInfoList({})
equipmentList.value = data || []
```

## 数据流程验证

### 1. 跳转流程
1. 检修单页面点击"备件使用记录"按钮
2. 调用 `handleManageSpareParts` 函数
3. 使用 `router.push` 跳转到备件使用记录页面，传递 `workOrderId` 和 `equipmentId` 参数

### 2. 参数接收
1. 备件使用记录页面在 `onMounted` 中接收URL参数
2. 将参数设置到 `queryParams.workOrderId` 和 `queryParams.equipmentId`
3. 调用 `getList()` 函数进行查询

### 3. 后端查询
1. 前端调用 `SparePartUsageRecordApi.getSparePartUsageRecordPage(queryParams)`
2. 后端Controller接收 `SparePartUsageRecordPageReqVO` 参数
3. 调用Service的 `getSparePartUsageRecordPage` 方法
4. Service调用Mapper的 `selectPage` 方法
5. **修复后**: Mapper根据 `workOrderId` 和 `equipmentId` 进行过滤查询

## 测试数据验证

根据用户提供的数据：

**检修单数据**:
- ID 13: 跳汰机相关检修单

**备件使用记录数据**:
- 记录3: equipment_id = 1, work_order_id = 1 (颚式破碎机)
- 记录4: equipment_id = 2, work_order_id = 2 (圆锥破碎机)
- 记录5: equipment_id = 3, work_order_id = 12 (跳汰机)
- 记录6: equipment_id = 3, work_order_id = 1 (跳汰机)
- 记录7: equipment_id = 2, work_order_id = 9 (圆锥破碎机)
- 记录8: equipment_id = 1, work_order_id = 12 (颚式破碎机)

**设备数据**:
- ID 1: 颚式破碎机
- ID 2: 圆锥破碎机
- ID 3: 跳汰机

## 预期结果

修复后，当从检修单ID=13跳转到备件使用记录页面时：

1. **URL**: `http://localhost/coal/sparepartusagerecord?workOrderId=13&equipmentId=3`
2. **过滤结果**: 应该显示与检修单ID=13和设备ID=3相关的备件使用记录
3. **设备名称显示**: 关联设备列应显示"跳汰机"而不是"设备ID: 3"
4. **搜索栏**: 设备下拉框应显示所有设备名称供选择

## 测试步骤

1. 重新编译后端代码
2. 刷新备件使用记录页面
3. 从检修单页面点击"备件使用记录"按钮
4. 验证页面是否正确过滤显示相关记录
5. 验证设备名称是否正确显示
6. 测试搜索栏的设备下拉选择功能

## 教训

1. **API方法验证**: 使用API方法前必须检查实际的方法签名和返回值结构
2. **后端查询条件**: 添加新的查询参数时，必须同时更新Mapper的查询条件
3. **完整测试**: 功能开发完成后需要进行端到端的完整测试
