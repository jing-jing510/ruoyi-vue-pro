# 备件管理模块关联功能规划方案

## 📋 当前状况分析

### ✅ 已完成的表和功能
1. **备件分类表** (`coal_spare_part_category`) - 树表 ✅
2. **备件基础信息表** (`coal_spare_part_info`) - 单表 ✅  
3. **备件库存记录表** (`coal_spare_part_stock`) - 单表 ✅
4. **备件出入库记录表** (`coal_spare_part_inventory_log`) - 单表 ✅
5. **备件预警记录表** (`coal_spare_part_alert`) - 单表 ✅
6. **备件使用记录表** (`coal_spare_part_usage_record`) - 单表 ✅
7. **设备档案表** (`coal_equipment_info`) - 单表（已存在）✅

### ❌ 缺失的表
1. **备件设备关联表** (`coal_spare_part_equipment`) - 主子表的子表 ❌

## 🎯 解决方案

### 方案一：创建备件设备关联表（推荐）

**原因：**
- 备件与设备是多对多关系，需要独立的关联表
- 记录备件在特定设备上的使用参数（安装位置、更换难度等）
- 支持一个备件适用于多个设备，一个设备使用多种备件

**实施步骤：**
1. 使用芋道代码生成器创建备件设备关联表（主子表）
2. 以备件基础信息为主表，备件设备关联为子表
3. 更新相关表单，增加设备选择功能

### 方案二：在现有表中添加设备字段（不推荐）

**缺点：**
- 无法处理多对多关系
- 数据冗余
- 不符合数据库设计规范

## 📊 关联关系图

```
备件分类表 (1:n) 备件基础信息表 (1:n) 备件设备关联表 (n:1) 设备档案表
                    ↓                          ↓
                库存记录表                  使用记录表
                    ↓                          ↓  
                出入库记录表                预警记录表
```

## 🚀 业务流程设计

### 第一步：分类管理
```
创建备件分类（大类 → 中类 → 小类）
```

### 第二步：备件信息管理
```
选择分类 → 填写备件基础信息 → 保存
```

### 第三步：设备关联管理
```
选择已创建的备件 → 添加适用设备 → 设置使用参数 → 保存关联关系
```

### 第四步：库存管理
```
备件入库 → 自动更新库存记录 → 触发预警检查
```

### 第五步：使用管理
```
设备维修 → 选择备件 → 记录使用情况 → 自动扣减库存
```

### 第六步：预警管理
```
系统监控 → 库存/到期预警 → 自动发送通知
```

## 🛠 需要实现的功能

### 1. 创建备件设备关联表
- 表名: `coal_spare_part_equipment`
- 类型: 主子表（以`coal_spare_part_info`为主表）
- 字段: 备件ID、设备ID、使用数量、安装位置、更换难度等

### 2. 更新表单组件

#### 2.1 备件基础信息表单
- 添加"关联设备"子表功能
- 支持多选设备
- 设置设备使用参数

#### 2.2 其他表单增加选择功能
- **备件使用记录**: 添加备件选择、设备选择
- **出入库记录**: 添加备件选择、设备选择  
- **预警记录**: 添加备件选择、设备选择
- **库存记录**: 添加备件选择

### 3. 创建选择组件API

#### 3.1 设备选择API
```typescript
// 获取设备简单列表
export const getSimpleEquipmentList = (): Promise<EquipmentVO[]> => {
  return request.get({ url: '/coal/equipment-info/simple-list' })
}
```

#### 3.2 备件选择API  
```typescript
// 获取备件简单列表
export const getSimpleSparePartList = (): Promise<SparePartVO[]> => {
  return request.get({ url: '/coal/spare-part-info/simple-list' })
}
```

#### 3.3 备件分类API
```typescript
// 获取分类树
export const getSparePartCategoryTree = (): Promise<CategoryTreeVO[]> => {
  return request.get({ url: '/coal/spare-part-category/tree' })
}
```

## 📋 实施计划

### 第一阶段：创建关联表
1. ✅ 使用芋道代码生成器创建`coal_spare_part_equipment`表
2. ✅ 生成对应的后端代码（Controller、Service、Mapper等）
3. ✅ 生成对应的前端代码（List、Form等）

### 第二阶段：API接口开发
1. ✅ 扩展设备档案Service，添加`getSimpleEquipmentList`方法
2. ✅ 扩展备件信息Service，添加`getSimpleSparePartList`方法  
3. ✅ 扩展备件分类Service，添加`getSparePartCategoryTree`方法

### 第三阶段：前端组件更新
1. ✅ 更新备件基础信息表单，集成设备关联子表
2. ✅ 更新其他表单，添加备件/设备选择功能
3. ✅ 创建统一的选择组件

### 第四阶段：业务逻辑集成
1. ✅ 实现库存自动更新逻辑
2. ✅ 实现预警检查机制
3. ✅ 完善数据一致性验证

## 💡 关键技术点

### 主子表关系处理
- 主表: `coal_spare_part_info` (备件基础信息)
- 子表: `coal_spare_part_equipment` (备件设备关联)
- 芋道框架支持主子表的联合操作

### 数据关联查询
- 使用MyBatis-Plus的关联查询
- 实现懒加载和级联操作
- 保证数据一致性

### 前端组件设计
- 使用Element Plus的级联选择器
- 支持搜索过滤
- 实现数据联动

## 🎯 预期效果

### 用户体验
1. **流程清晰**: 分类→备件→关联→库存→使用→预警
2. **操作便捷**: 下拉选择、搜索过滤、数据联动
3. **数据准确**: 自动计算、实时更新、预警提示

### 数据管理
1. **关系完整**: 所有表通过外键关联
2. **数据一致**: 库存自动更新、状态同步
3. **业务完整**: 覆盖备件管理全流程

## 📝 注意事项

1. **不修改设备档案表**: 保持现有设备档案表结构不变
2. **保持数据完整性**: 设置合理的外键约束
3. **考虑性能**: 大数据量时的查询优化
4. **用户权限**: 不同角色的操作权限控制

---

**下一步行动**: 
1. 立即使用芋道代码生成器创建`coal_spare_part_equipment`表
2. 配置主子表关系
3. 实现选择组件API
