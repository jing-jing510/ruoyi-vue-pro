# 设备维护业务流程实现总结

## 已完成的功能

### 1. 数据库模拟数据
- **文件**: `learn/设备维护业务流程模拟数据.sql`
- **内容**: 包含报修单、检修单、备件使用记录、备件出入库记录的完整模拟数据
- **数据量**: 5条报修单、4条检修单、6条备件使用记录、4条备件出入库记录

### 2. 报修单到检修单流程
- **实现方式**: 添加按钮，手动触发
- **位置**: 报修单列表页面操作列
- **功能**: 
  - 只有状态为"待处理"的报修单才显示"生成检修单"按钮
  - 点击后确认生成检修单
  - 自动填充检修单基本信息（设备、故障描述、紧急程度等）
  - 自动设置检修类型为"故障检修"
  - 根据故障级别自动确定检修级别

### 3. 检修单到备件使用记录流程
- **实现方式**: 添加按钮，跳转管理
- **位置**: 检修单列表页面操作列
- **功能**:
  - 点击"备件使用记录"按钮跳转到备件使用记录页面
  - 自动传递检修单ID和设备ID作为查询条件
  - 在备件使用记录页面可以添加、编辑、删除备件使用记录

### 4. 首页组件
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/components/EquipmentMaintenanceOverview.vue`
- **功能**:
  - 待处理报修单统计
  - 进行中检修单统计
  - 本月备件使用统计
  - 设备完好率计算
  - 最近报修单列表展示
  - 快速跳转到相关页面

## 业务流程说明

### 完整业务流程
```
报修单(待处理) → [生成检修单按钮] → 检修单(待执行) → [备件使用记录按钮] → 备件使用记录 → 备件库存自动更新
```

### 操作方式
1. **报修单到检修单**: 手动按钮触发（需要人工审核和派单）
2. **检修单到备件使用记录**: 手动按钮跳转管理（需要记录实际使用的备件）
3. **备件库存更新**: 自动触发（当备件使用记录创建时）

## 技术实现细节

### 1. 报修单页面修改
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/repairrequest/index.vue`
- **修改内容**:
  - 添加"生成检修单"按钮
  - 添加 `handleCreateMaintenanceOrder` 函数
  - 引入 `MaintenanceOrderApi`

### 2. 检修单页面修改
- **文件**: `yudao-ui/yudao-ui-admin-vue3/src/views/coal/maintenanceorder/index.vue`
- **修改内容**:
  - 添加"备件使用记录"按钮
  - 添加 `handleManageSpareParts` 函数
  - 引入 `SparePartUsageRecordApi`

### 3. 首页组件特性
- **响应式设计**: 支持不同屏幕尺寸
- **实时数据**: 自动获取最新统计数据
- **快速导航**: 一键跳转到相关页面
- **状态展示**: 直观显示各种状态和数量

## 数据关联关系

### 报修单 → 检修单
- `coal_repair_request.id` → `coal_maintenance_order.repair_request_id`
- 自动继承设备信息、故障描述、紧急程度等

### 检修单 → 备件使用记录
- `coal_maintenance_order.id` → `coal_spare_part_usage_record.work_order_id`
- 通过URL参数传递关联信息

### 备件使用记录 → 备件库存
- 自动扣减备件库存
- 触发备件预警检查

## 使用说明

### 1. 执行模拟数据
```sql
-- 执行模拟数据SQL文件
source learn/设备维护业务流程模拟数据.sql
```

### 2. 业务流程操作
1. 在报修单页面，找到状态为"待处理"的报修单
2. 点击"生成检修单"按钮
3. 确认生成检修单
4. 在检修单页面，点击"备件使用记录"按钮
5. 在备件使用记录页面管理备件使用情况

### 3. 首页组件使用
- 组件会自动显示最新的统计数据
- 点击各个统计卡片可以跳转到对应页面
- 点击"刷新"按钮可以更新数据

## 注意事项

1. **权限控制**: 所有按钮都有相应的权限控制
2. **数据验证**: 生成检修单时会验证报修单状态
3. **错误处理**: 包含完整的错误处理和用户提示
4. **响应式设计**: 首页组件支持不同屏幕尺寸
5. **数据一致性**: 确保业务流程中的数据关联正确

## 下一步扩展

1. **自动流程**: 可以考虑添加自动生成检修单的规则
2. **消息通知**: 添加业务流程状态变更的消息通知
3. **报表统计**: 添加更详细的统计报表
4. **移动端支持**: 优化移动端显示效果
